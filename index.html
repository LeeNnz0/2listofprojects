<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truck Dispatch System</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">üöõ Truck Dispatch System</h1>
            
            <!-- Selection Form -->
            <div class="space-y-6 mb-8">
                <!-- Truck Type Selection -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Select Truck Type</label>
                    <div class="flex gap-3">
                        <button id="denjoBtn" class="flex-1 p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors text-center font-semibold" onclick="selectTruckType('denjo')">
                            üöõ Denjo Trucks
                        </button>
                        <button id="subconBtn" class="flex-1 p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors text-center font-semibold" onclick="selectTruckType('subcon')">
                            üöö Subcon Trucks
                        </button>
                    </div>
                </div>

                <!-- Plate Number Search (Always Visible) -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Search Plate Number</label>
                    
                    <!-- Manual Search Input -->
                    <div class="mb-4">
                        <input type="text" id="plateSearch" placeholder="Type plate number to search (e.g. 'NK' or 'AAV')..." 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                               oninput="filterPlates()" onkeypress="handleEnterKey(event)">
                        <div class="text-xs text-gray-500 mt-1">üí° Start typing - truck type will be detected automatically! Click plates to select multiple.</div>
                    </div>
                    
                    <!-- Selected Plates Display -->
                    <div id="selectedPlatesDisplay" class="hidden mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-semibold text-green-700">Selected Plates:</span>
                            <button onclick="clearAllSelectedPlates()" class="text-xs text-red-500 hover:text-red-700 font-semibold">Clear All</button>
                        </div>
                        <div id="selectedPlatesList" class="flex flex-wrap gap-2">
                        </div>
                    </div>
                    
                    <div id="plateButtons" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
                        <div class="col-span-full text-center text-gray-500 py-4">Start typing to see matching plate numbers</div>
                    </div>
                </div>

                <!-- Location Selection -->
                <div id="locationSection" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Select Location</label>
                    <div id="locationButtons" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                    </div>
                </div>

                <!-- Site Selection -->
                <div id="siteSection" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Select Site</label>
                    <div id="siteButtons" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
                    </div>
                </div>

                <!-- Date and Rate -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Date</label>
                        <input type="date" id="dispatchDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-sm font-semibold text-gray-700 mb-1">Current Rate</div>
                        <div id="currentRate" class="text-2xl font-bold text-blue-600">‚Ç±0.00</div>
                    </div>
                </div>
            </div>
            
            <button id="addDispatch" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                Add Dispatch Entry
            </button>
        </div>
        
        <!-- Multi-Site Dispatch Section -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-6 border-2 border-purple-200">
            <h2 class="text-2xl font-bold text-purple-800 mb-6">üöõ‚û°Ô∏èüè¢ Multi-Site Dispatch</h2>
            <p class="text-sm text-gray-600 mb-6">Perfect for when the same plates visit multiple sites! Select plates once, then pick all the sites they visited.</p>
            
            <div class="space-y-6">
                <!-- Multi Truck Type Selection -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Select Truck Type</label>
                    <div class="flex gap-3">
                        <button id="multiDenjoBtn" class="flex-1 p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors text-center font-semibold" onclick="selectMultiTruckType('denjo')">
                            üöõ Denjo Trucks
                        </button>
                        <button id="multiSubconBtn" class="flex-1 p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors text-center font-semibold" onclick="selectMultiTruckType('subcon')">
                            üöö Subcon Trucks
                        </button>
                    </div>
                </div>

                <!-- Multi Plate Search -->
                <div id="multiPlateSection" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Search & Select Multiple Plates</label>
                    
                    <div class="mb-4">
                        <input type="text" id="multiPlateSearch" placeholder="Type plate number to search..." 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                               oninput="filterMultiPlates()">
                        <div class="text-xs text-gray-500 mt-1">üí° Click multiple plates to select them all at once!</div>
                    </div>
                    
                    <!-- Multi Selected Plates Display -->
                    <div id="multiSelectedPlatesDisplay" class="hidden mb-4 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-semibold text-purple-700">Selected Plates:</span>
                            <button onclick="clearAllMultiSelectedPlates()" class="text-xs text-red-500 hover:text-red-700 font-semibold">Clear All</button>
                        </div>
                        <div id="multiSelectedPlatesList" class="flex flex-wrap gap-2">
                        </div>
                    </div>
                    
                    <div id="multiPlateButtons" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 mb-6">
                        <div class="col-span-full text-center text-gray-500 py-4">Select truck type first</div>
                    </div>
                </div>

                <!-- Multi Location & Sites Selection -->
                <div id="multiLocationSection" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Select Location</label>
                    <div id="multiLocationButtons" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 mb-6">
                    </div>
                    
                    <div id="multiSiteSection" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Select Multiple Sites</label>
                        <div class="text-xs text-gray-500 mb-3">üí° Click multiple sites - each selected plate will be recorded for each selected site!</div>
                        
                        <!-- Multi Selected Sites Display -->
                        <div id="multiSelectedSitesDisplay" class="hidden mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-semibold text-blue-700">Selected Sites with Dates:</span>
                                <button onclick="clearAllMultiSelectedSites()" class="text-xs text-red-500 hover:text-red-700 font-semibold">Clear All</button>
                            </div>
                            <div class="text-xs text-gray-600 mb-3">üí° Click on any site below to change its date!</div>
                            <div id="multiSelectedSitesList" class="space-y-2">
                            </div>
                        </div>
                        
                        <div id="multiSiteButtons" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
                        </div>
                    </div>
                </div>

                <!-- Multi Preview -->
                <div class="bg-purple-50 p-4 rounded-lg">
                    <div class="text-sm font-semibold text-gray-700 mb-1">Total Records to Create</div>
                    <div id="multiRecordCount" class="text-2xl font-bold text-purple-600">0 records</div>
                    <div id="multiTotalAmount" class="text-lg font-semibold text-green-600">‚Ç±0.00</div>
                </div>
            </div>
            
            <button id="addMultiDispatch" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed mt-6" disabled>
                Create All Dispatch Records
            </button>
        </div>
        
        <!-- Site Totals -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">üè¢ Site Totals</h2>
            <div id="siteTotals" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="text-gray-500 text-center py-8 col-span-full">No sites added yet. Add dispatch entries to see totals!</div>
            </div>
        </div>

        <!-- Dispatch Records -->
        <div class="bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">üìã Dispatch Records</h2>
            <div id="dispatchRecords" class="space-y-4">
                <div class="text-gray-500 text-center py-8">No dispatch records yet. Add your first entry above!</div>
            </div>
        </div>
    </div>

    <script>
        // Data
        const denjoPlates = [
            'AAV 3315', 'ABD 2336', 'CAE 8359', 'MAK 4606', 'MAL 7663', 'NAJ 6390', 
            'NAM 7981', 'NAM 7982', 'NAX 5523', 'NAZ 1509', 'NBA 1561', 'NBA 1570', 
            'NBA 1573', 'NBA 1574', 'NDH 2626', 'NDM 3414', 'NDM 4083', 'NFZ 2650', 
            'NFZ 2658', 'NGB 1550', 'NIF 1814', 'NKF 1653', 'NKF 1663'
        ].sort();

        const subconPlates = [
            'ABH 293', 'ALA 7244', 'CAG 1899', 'CBP 881', 'KAS 6089', 'KAT 4965',
            'MBF 6760', 'MBI 5795', 'MV 2253', 'MV 3160', 'NCK 6502', 'NES 3903', 'NES 7099', 
            'NES 9440', 'NFO 1978', 'NFQ 1221', 'NFV 8013', 'NFX 7968', 'NGB 3188', 'NGF 1435', 
            'NGR 4654', 'NGL 9012', 'NID 4886', 'NII 253', 'NIK 7805', 'NKR 4609', 
            'NKR 4879', 'NKR 5126', 'NKR 5127', 'NKR 5128', 'NKR 5129', 'NKR 5130', 'NKR 5131', 'NQE 393', 'RFC 991', 
            'RGZ 134', 'RMJ 498', 'RNE 172', 'WMZ 181'
        ].sort();

        const denjoRates = {
            'ALABANG': 3928.57,
            'BGC/TAGUIG': 3482.14,
            'BICUTAN': 3705.36,
            'CALOOCAN': 4107.14,
            'CUBAO': 3928.57,
            'FTI/ARCA SOUTH': 2857.14,
            'LAS PINAS': 3928.57,
            'MAKATI': 3348.21,
            'MALABON': 4107.14,
            'MANDALUYONG': 3660.71,
            'MANILA': 4017.14,
            'MUNTINLUPA': 3923.21,
            'PARANAQUE': 3883.93,
            'PASAY': 3928.57,
            'PASIG': 3750,
            'QC': 3928.57,
            'SUCAT': 3839.29,
            'VALENZUELA': 4821.43
        };

        const subconRates = {
            'ALABANG': 2000,
            'ARCA SOUTH/FTI': 1600,
            'ASEANA': 1900,
            'BBG': 1600,
            'BGC/TAGUIG': 1600,
            'CAVITE': 2300,
            'FAIRVIEW': 2000,
            'MAKATI': 1700,
            'MANDALUYONG': 1900,
            'MANILA': 2000,
            'NUVALI': 2300,
            'PARANAQUE': 1900,
            'PASIG': 1700,
            'QC': 2000
        };

        const locationSites = {
            'ALABANG': [
                'AMAIA STEPS ALABANG',
                'AVIDA SUCAT',
                'AVIDA TOWERS ARDANE T1',
                'NUEVO T1 (CERCA B3 T1)',
                'VIENTO T3'
            ].sort(),
            'ARCA SOUTH/FTI': [
                'ARBOR LANES PHASE 3 BLOCK 4',
                'ARBOR LANES PHASE 3 BLOCK 5',
                'ARCA SOUTH PIE MALL',
                'ARCA SOUTH PIE P1 BPO 1 (AGB) (1G2)',
                'ARCA YARD',
                'GARDENCOURT RESIDENCES ‚Äì MOLAVE',
                'GARDENCOURT RESIDENCES ‚Äì NARRA',
                'INTEGRATED BASEMENT PARKING',
                'INTERACTIVE PARK',
                'PARK CASCADES 1',
                'PARK CASCADES B2 G B3',
                'SEDA ARCA SOUTH',
                'TR YNE ENTERPRISE PLAZA (XAVIER B1)',
                'TR YNE PHASE 2',
                'VERANDA',
                'VIREO'
            ].sort(),
            'FTI/ARCA SOUTH': [
                'ARBOR LANES PHASE 3 BLOCK 4',
                'ARBOR LANES PHASE 3 BLOCK 5',
                'ARCA SOUTH PIE MALL',
                'ARCA SOUTH PIE P1 BPO 1 (AGB) (1G2)',
                'ARCA YARD',
                'GARDENCOURT RESIDENCES ‚Äì MOLAVE',
                'GARDENCOURT RESIDENCES ‚Äì NARRA',
                'INTEGRATED BASEMENT PARKING',
                'INTERACTIVE PARK',
                'PARK CASCADES 1',
                'PARK CASCADES B2 G B3',
                'SEDA ARCA SOUTH',
                'TR YNE ENTERPRISE PLAZA (XAVIER B1)',
                'TR YNE PHASE 2',
                'VERANDA',
                'VIREO'
            ].sort(),
            'ASEANA': ['Site ASE1', 'Site ASE2'].sort(),
            'BBG': ['Site BBG1', 'Site BBG2'].sort(),
            'BGC/TAGUIG': [
                'PARK EAST PLACE (MACE)',
                'PARK TRIANGLE MALL (CHEWEE)',
                'PARK TRIANGLE MALL (LIGHTSABER)',
                'VERVE 1'
            ].sort(),
            'BICUTAN': ['Site B1', 'Site B2'].sort(),
            'CALOOCAN': ['Site C1', 'Site C2'].sort(),
            'CAVITE': ['Site CV1', 'Site CV2', 'Site CV3'].sort(),
            'CUBAO': ['Site CB1', 'Site CB2', 'Site CB3'].sort(),
            'FAIRVIEW': ['Site FV1', 'Site FV2'].sort(),
            'FTI/ARCA SOUTH': ['Site FTI1', 'Site FTI2'].sort(),
            'LAS PINAS': ['Site LP1', 'Site LP2'].sort(),
            'MAKATI': [
                'ASTELA T1 (CIRCUIT T5)',
                'ASTELA T1 + PODIUM',
                'AYALA MALLS GLORIETA',
                'BPI HQ REDEVELOPMENT',
                'CALLISTO 1',
                'CALLISTO 2',
                'CIRCUIT FLATS',
                'GENTRY PLAZA',
                'GENTRY RESIDENTIAL',
                'GLORIETA REINVENTION',
                'GREENBELT 1 REDEVELOPMENT',
                'GREENBELT REINVENTION',
                'HOLIDAY INN',
                'LEGACY (VARIOUS PROJECT)',
                'LTG LAND DEVELOPMENT AT MAKATI',
                'MANDARIN ORIENTAL (ATG)',
                'MERGENT RESIDENCES PHASE 1',
                'MERGENT T1 + PODIUM',
                'METROBANK',
                'ONE AYALA AVE',
                'PARK CENTRAL NORTH',
                'PARK CENTRAL SOUTH',
                'PARK VILLAS',
                'PARKFORD SUITES',
                'PARKFORD SUITES (LIFESAVER) AT MAKATI',
                'PARKFORD SUITES 3',
                'SEDA OAA (ORA SEDA HOTEL)',
                'SHATTER SHY',
                'SOUTHPOINT T2',
                'SOUTHPOINT T3'
            ].sort(),
            'MALABON': ['Site ML1', 'Site ML2'].sort(),
            'MANDALUYONG': [
                'AMAIA SHAW',
                'AVIDA TOWERS VERGE T2'
            ].sort(),
            'MANILA': [
                'AMAIA SKIES AVENIDA'
            ].sort(),
            'MUNTINLUPA': ['Site MT1', 'Site MT2'].sort(),
            'NUVALI': ['Site NV1', 'Site NV2'].sort(),
            'PARANAQUE': [
                'AYALA MALLS MANILA BAY'
            ].sort(),
            'PASAY': [
                'AVIDA CENTRALIS (PRIME TAFT T4)',
                'PATIO MADRIGAL T1'
            ].sort(),
            'PASIG': [
                'PARKLINKS (BLOOM)',
                'THE AMERITNE AT PORTICO',
                'THE LATTICE'
            ].sort(),
            'QC': [
                'ALP PARKLINKS NORTH (MANGO BRAVO)',
                'ALP PARKLINKS SOUTH',
                'AMAIA SKIES CUBAO T3',
                'AMAIA STEP THE JUCTION PLACE CLARA',
                'AMAIA STEPS JUNCTION DELICIA',
                'OREAN PLACE 1',
                'OREAN PLACE 2',
                'PARKLINKS MALL',
                'TRINOMA EXPANSION',
                'VERTIS NORTH HYDRA',
                'VERTIS NORTH PH1 T4 BPO',
                'VERTIS NORTH PH1 T5 BPO'
            ].sort(),
            'SUCAT': ['Site S1', 'Site S2'].sort(),
            'VALENZUELA': ['Site V1', 'Site V2'].sort()
        };

        let dispatchRecords = [];
        let siteTotals = {};
        let selectedTruckType = '';
        let selectedPlates = [];
        let selectedLocation = '';
        let selectedSite = '';

        // Multi-site variables
        let multiSelectedTruckType = '';
        let multiSelectedPlates = [];
        let multiSelectedLocation = '';
        let multiSelectedSites = [];
        let multiSitesByLocation = {}; // Track sites by location with dates: {location: [{site: 'siteName', date: 'YYYY-MM-DD'}]}

        // DOM elements
        const dispatchDateInput = document.getElementById('dispatchDate');
        const currentRateDiv = document.getElementById('currentRate');
        const addDispatchBtn = document.getElementById('addDispatch');
        const dispatchRecordsDiv = document.getElementById('dispatchRecords');
        const siteTotalsDiv = document.getElementById('siteTotals');
        
        // Multi-site DOM elements
        const addMultiDispatchBtn = document.getElementById('addMultiDispatch');
        const multiRecordCountDiv = document.getElementById('multiRecordCount');
        const multiTotalAmountDiv = document.getElementById('multiTotalAmount');

        // Load data from localStorage on page load
        function loadData() {
            const savedRecords = localStorage.getItem('dispatchRecords');
            if (savedRecords) {
                dispatchRecords = JSON.parse(savedRecords);
                updateSiteTotals();
                renderDispatchRecords();
                renderSiteTotals();
            }
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('dispatchRecords', JSON.stringify(dispatchRecords));
        }

        // Set today's date as default
        dispatchDateInput.valueAsDate = new Date();

        // Event listeners
        addDispatchBtn.addEventListener('click', addDispatchRecord);
        addMultiDispatchBtn.addEventListener('click', addMultiDispatchRecord);

        // Load saved data when page loads
        loadData();

        function selectTruckType(type) {
            selectedTruckType = type;
            // Don't reset selectedPlates if they were auto-selected from search
            if (!document.getElementById('plateSearch').value) {
                selectedPlates = [];
                updateSelectedPlatesDisplay();
            }
            selectedLocation = '';
            selectedSite = '';
            
            // Update button styles
            document.getElementById('denjoBtn').className = type === 'denjo' ? 
                'flex-1 p-4 border-2 border-blue-500 bg-blue-50 rounded-lg text-center font-semibold text-blue-700' :
                'flex-1 p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors text-center font-semibold';
            
            document.getElementById('subconBtn').className = type === 'subcon' ? 
                'flex-1 p-4 border-2 border-green-500 bg-green-50 rounded-lg text-center font-semibold text-green-700' :
                'flex-1 p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors text-center font-semibold';
            
            // Show location section and populate locations
            const locationSection = document.getElementById('locationSection');
            const locationButtons = document.getElementById('locationButtons');
            locationSection.classList.remove('hidden');
            
            const rates = type === 'denjo' ? denjoRates : subconRates;
            locationButtons.innerHTML = Object.keys(rates).map(location => 
                `<button class="p-3 border border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-sm font-medium" onclick="selectLocation('${location}')">${location}</button>`
            ).join('');
            
            // Hide site section initially
            document.getElementById('siteSection').classList.add('hidden');
            
            updateRate();
        }

        function renderPlateButtons(filteredPlates = null) {
            const plateButtons = document.getElementById('plateButtons');
            const plates = filteredPlates || (selectedTruckType === 'denjo' ? denjoPlates : subconPlates);
            
            if (plates.length === 0) {
                plateButtons.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">No plates found matching your search</div>';
                return;
            }
            
            plateButtons.innerHTML = plates.map(plate => 
                `<button class="${selectedPlates.includes(plate) ? 'p-2 border-2 border-green-500 bg-green-50 rounded-lg text-sm font-medium text-green-700' : 'p-2 border border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-sm font-medium'}" onclick="togglePlateSelection('${plate}')">${plate}</button>`
            ).join('');
        }

        function renderMixedPlateButtons(denjoMatches, subconMatches) {
            const plateButtons = document.getElementById('plateButtons');
            
            // Combine and sort all matches
            const allMatches = [...denjoMatches, ...subconMatches].sort();
            
            plateButtons.innerHTML = allMatches.map(plate => {
                const isDenjo = denjoMatches.includes(plate);
                const truckTypeColor = isDenjo ? 'blue' : 'green';
                const truckTypeLabel = isDenjo ? 'D' : 'S';
                const isSelected = selectedPlates.includes(plate);
                
                return `<button class="${isSelected ? 'p-2 border-2 border-green-500 bg-green-50 rounded-lg text-sm font-medium text-green-700' : `p-2 border border-gray-300 rounded-lg hover:border-${truckTypeColor}-500 hover:bg-${truckTypeColor}-50 transition-colors text-sm font-medium`}" onclick="selectPlateWithType('${plate}', '${isDenjo ? 'denjo' : 'subcon'}')">
                    <div class="flex items-center justify-between">
                        <span>${plate}</span>
                        <span class="ml-1 px-1 py-0.5 text-xs rounded ${isDenjo ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}">${truckTypeLabel}</span>
                    </div>
                </button>`;
            }).join('');
        }

        function filterPlates() {
            const searchTerm = document.getElementById('plateSearch').value.toUpperCase();
            
            if (searchTerm.length === 0) {
                // Reset everything if search is empty
                if (selectedTruckType) {
                    renderPlateButtons();
                } else {
                    // Show initial message when no truck type selected and no search
                    document.getElementById('plateButtons').innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">Start typing to see matching plate numbers</div>';
                }
                return;
            }
            
            // Search in both denjo and subcon plates regardless of selected truck type
            const denjoMatches = denjoPlates.filter(plate => 
                plate.toUpperCase().includes(searchTerm)
            );
            const subconMatches = subconPlates.filter(plate => 
                plate.toUpperCase().includes(searchTerm)
            );
            
            // Combine all matches and show them
            const allMatches = [...denjoMatches, ...subconMatches].sort();
            
            if (allMatches.length === 0) {
                // No matches found
                renderPlateButtons([]);
                return;
            }
            
            // Auto-detect and set truck type if only one type has matches
            if (denjoMatches.length > 0 && subconMatches.length === 0) {
                // Only Denjo matches found
                if (selectedTruckType !== 'denjo') {
                    selectTruckType('denjo');
                }
                renderPlateButtons(denjoMatches);
            } else if (subconMatches.length > 0 && denjoMatches.length === 0) {
                // Only Subcon matches found
                if (selectedTruckType !== 'subcon') {
                    selectTruckType('subcon');
                }
                renderPlateButtons(subconMatches);
            } else {
                // Both types have matches - show all with type indicators
                renderMixedPlateButtons(denjoMatches, subconMatches);
            }
        }

        function togglePlateSelection(plate) {
            if (selectedPlates.includes(plate)) {
                // Remove plate from selection
                selectedPlates = selectedPlates.filter(p => p !== plate);
            } else {
                // Add plate to selection
                selectedPlates.push(plate);
                
                // Clear search input after selecting a plate
                document.getElementById('plateSearch').value = '';
                
                // Reset plate buttons to show all available plates for current truck type
                if (selectedTruckType) {
                    renderPlateButtons();
                }
            }
            
            // Update displays
            updateSelectedPlatesDisplay();
            updateRate();
        }

        function selectPlateWithType(plate, truckType) {
            // Auto-select truck type if not already selected or if different
            if (selectedTruckType !== truckType) {
                selectTruckType(truckType);
            }
            
            // Add plate to selection
            if (!selectedPlates.includes(plate)) {
                selectedPlates.push(plate);
            }
            
            // Clear search input after selecting a plate
            document.getElementById('plateSearch').value = '';
            
            // Reset plate buttons to show all available plates for current truck type
            renderPlateButtons();
            
            // Update displays
            updateSelectedPlatesDisplay();
            updateRate();
        }

        function updateSelectedPlatesDisplay() {
            const display = document.getElementById('selectedPlatesDisplay');
            const list = document.getElementById('selectedPlatesList');
            
            if (selectedPlates.length === 0) {
                display.classList.add('hidden');
                return;
            }
            
            display.classList.remove('hidden');
            list.innerHTML = selectedPlates.map(plate => 
                `<span class="inline-flex items-center gap-1 px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
                    ${plate}
                    <button onclick="removePlateFromSelection('${plate}')" class="text-green-500 hover:text-green-700 ml-1">√ó</button>
                </span>`
            ).join('');
        }

        function removePlateFromSelection(plate) {
            selectedPlates = selectedPlates.filter(p => p !== plate);
            updateSelectedPlatesDisplay();
            renderPlateButtons();
            updateRate();
        }

        function clearAllSelectedPlates() {
            selectedPlates = [];
            updateSelectedPlatesDisplay();
            renderPlateButtons();
            updateRate();
        }

        function selectLocation(location) {
            selectedLocation = location;
            selectedSite = '';
            
            // Update location button styles
            const rates = selectedTruckType === 'denjo' ? denjoRates : subconRates;
            const locationButtons = document.getElementById('locationButtons');
            locationButtons.innerHTML = Object.keys(rates).map(loc => 
                `<button class="${loc === location ? 'p-3 border-2 border-blue-500 bg-blue-50 rounded-lg text-sm font-medium text-blue-700' : 'p-3 border border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-sm font-medium'}" onclick="selectLocation('${loc}')">${loc}</button>`
            ).join('');
            
            // Show and populate site section
            const siteSection = document.getElementById('siteSection');
            const siteButtons = document.getElementById('siteButtons');
            siteSection.classList.remove('hidden');
            
            if (locationSites[location]) {
                siteButtons.innerHTML = locationSites[location].map(site => 
                    `<button class="p-2 border border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-sm font-medium" onclick="selectSite('${site}')">${site}</button>`
                ).join('');
            }
            
            updateRate();
        }

        function selectSite(site) {
            selectedSite = site;
            
            // Update site button styles
            const siteButtons = document.getElementById('siteButtons');
            siteButtons.innerHTML = locationSites[selectedLocation].map(s => 
                `<button class="${s === site ? 'p-2 border-2 border-blue-500 bg-blue-50 rounded-lg text-sm font-medium text-blue-700' : 'p-2 border border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-sm font-medium'}" onclick="selectSite('${s}')">${s}</button>`
            ).join('');
            
            updateRate();
        }

        function updateRate() {
            if (!selectedTruckType || !selectedLocation || selectedPlates.length === 0) {
                currentRateDiv.textContent = '‚Ç±0.00';
                addDispatchBtn.disabled = true;
                return;
            }

            const rates = selectedTruckType === 'denjo' ? denjoRates : subconRates;
            const rate = rates[selectedLocation] || 0;
            const totalRate = rate * selectedPlates.length;
            
            currentRateDiv.textContent = `‚Ç±${totalRate.toLocaleString('en-PH', {minimumFractionDigits: 2})} (${selectedPlates.length} plates √ó ‚Ç±${rate.toLocaleString('en-PH', {minimumFractionDigits: 2})})`;
            
            // Enable add button if all fields are filled
            const allFieldsFilled = selectedPlates.length > 0 && selectedLocation && selectedSite && dispatchDateInput.value;
            addDispatchBtn.disabled = !allFieldsFilled;
        }

        function addDispatchRecord() {
            const rate = selectedTruckType === 'denjo' ? 
                      denjoRates[selectedLocation] : 
                      subconRates[selectedLocation];

            // Create a record for each selected plate
            selectedPlates.forEach(plate => {
                const record = {
                    id: Date.now() + Math.random(), // Ensure unique IDs
                    truckType: selectedTruckType,
                    plateNumber: plate,
                    location: selectedLocation,
                    site: selectedSite,
                    date: dispatchDateInput.value,
                    rate: rate
                };
                dispatchRecords.push(record);
            });

            saveData(); // Save to localStorage
            updateSiteTotals();
            renderDispatchRecords();
            renderSiteTotals();
            
            // Reset form
            resetForm();
            
            // Show success message
            showSuccessMessage();
        }

        function resetForm() {
            selectedTruckType = '';
            selectedPlates = [];
            selectedLocation = '';
            selectedSite = '';
            
            // Reset truck type buttons
            document.getElementById('denjoBtn').className = 'flex-1 p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors text-center font-semibold';
            document.getElementById('subconBtn').className = 'flex-1 p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors text-center font-semibold';
            
            // Clear search input
            document.getElementById('plateSearch').value = '';
            
            // Hide sections
            document.getElementById('locationSection').classList.add('hidden');
            document.getElementById('siteSection').classList.add('hidden');
            
            // Reset plate buttons to initial state
            document.getElementById('plateButtons').innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">Start typing to see matching plate numbers</div>';
            
            // Hide selected plates display
            updateSelectedPlatesDisplay();
            
            // Reset rate and button
            currentRateDiv.textContent = '‚Ç±0.00';
            addDispatchBtn.disabled = true;
        }

        function updateSiteTotals() {
            siteTotals = {};
            
            dispatchRecords.forEach(record => {
                const siteKey = `${record.location} - ${record.site}`;
                if (!siteTotals[siteKey]) {
                    siteTotals[siteKey] = {
                        location: record.location,
                        site: record.site,
                        total: 0,
                        count: 0,
                        denjoTotal: 0,
                        subconTotal: 0,
                        denjoCount: 0,
                        subconCount: 0
                    };
                }
                
                siteTotals[siteKey].total += record.rate;
                siteTotals[siteKey].count += 1;
                
                if (record.truckType === 'denjo') {
                    siteTotals[siteKey].denjoTotal += record.rate;
                    siteTotals[siteKey].denjoCount += 1;
                } else {
                    siteTotals[siteKey].subconTotal += record.rate;
                    siteTotals[siteKey].subconCount += 1;
                }
            });
        }

        function renderSiteTotals() {
            if (Object.keys(siteTotals).length === 0) {
                siteTotalsDiv.innerHTML = '<div class="text-gray-500 text-center py-8 col-span-full">No sites added yet. Add dispatch entries to see totals!</div>';
                return;
            }

            siteTotalsDiv.innerHTML = Object.entries(siteTotals).map(([siteKey, data]) => `
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-6 border border-blue-200 cursor-pointer hover:shadow-lg transition-shadow" onclick="showSiteDetails('${siteKey}')">
                    <div class="text-sm font-semibold text-gray-600 mb-1">${data.location}</div>
                    <div class="text-lg font-bold text-gray-800 mb-4">${data.site}</div>
                    <div class="text-xs text-blue-600 mb-4">üëÜ Click to see plate details</div>
                    <div class="space-y-3">
                        ${data.denjoCount > 0 ? `
                        <div class="bg-blue-100 rounded-lg p-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-bold text-blue-700">DENJO TOTAL:</span>
                                <span class="text-lg font-bold text-blue-700">‚Ç±${data.denjoTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                            </div>
                            <div class="text-xs text-blue-600">${data.denjoCount} trips</div>
                        </div>
                        ` : ''}
                        ${data.subconCount > 0 ? `
                        <div class="bg-green-100 rounded-lg p-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-bold text-green-700">SUBCON TOTAL:</span>
                                <span class="text-lg font-bold text-green-700">‚Ç±${data.subconTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                            </div>
                            <div class="text-xs text-green-600">${data.subconCount} trips</div>
                        </div>
                        ` : ''}
                        <div class="border-t border-gray-300 pt-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-bold text-gray-700">GRAND TOTAL:</span>
                                <span class="text-xl font-bold text-purple-600">‚Ç±${data.total.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                            </div>
                            <div class="text-xs text-gray-600">${data.count} total trips</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderDispatchRecords() {
            if (dispatchRecords.length === 0) {
                dispatchRecordsDiv.innerHTML = '<div class="text-gray-500 text-center py-8">No dispatch records yet. Add your first entry above!</div>';
                return;
            }

            dispatchRecordsDiv.innerHTML = dispatchRecords.map(record => `
                <div class="bg-gray-50 rounded-lg p-4 border-l-4 ${record.truckType === 'denjo' ? 'border-blue-500' : 'border-green-500'}">
                    <div class="flex justify-between items-start">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 flex-1">
                            <div>
                                <div class="text-xs font-semibold text-gray-500 uppercase">Truck Type</div>
                                <div class="font-semibold ${record.truckType === 'denjo' ? 'text-blue-600' : 'text-green-600'}">${record.truckType.toUpperCase()}</div>
                            </div>
                            <div>
                                <div class="text-xs font-semibold text-gray-500 uppercase">Plate Number</div>
                                <div class="font-semibold">${record.plateNumber}</div>
                            </div>
                            <div>
                                <div class="text-xs font-semibold text-gray-500 uppercase">Location</div>
                                <div class="font-semibold">${record.location}</div>
                            </div>
                            <div>
                                <div class="text-xs font-semibold text-gray-500 uppercase">Site</div>
                                <div class="font-semibold">${record.site}</div>
                            </div>
                            <div>
                                <div class="text-xs font-semibold text-gray-500 uppercase">Date</div>
                                <div class="font-semibold">${new Date(record.date).toLocaleDateString('en-PH')}</div>
                            </div>
                            <div>
                                <div class="text-xs font-semibold text-gray-500 uppercase">Rate</div>
                                <div class="font-bold text-lg text-green-600">‚Ç±${record.rate.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                            </div>
                        </div>
                        <div class="ml-4 flex gap-2">
                            <button onclick="editRecord(${record.id})" class="text-blue-500 hover:text-blue-700 font-semibold">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="removeRecord(${record.id})" class="text-red-500 hover:text-red-700 font-semibold">
                                ‚úï
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function editRecord(id) {
            const record = dispatchRecords.find(r => r.id === id);
            if (!record) return;
            
            // Fill form with existing data
            selectTruckType(record.truckType);
            
            // Wait a bit for the UI to update, then select other fields
            setTimeout(() => {
                selectedPlates = [record.plateNumber];
                updateSelectedPlatesDisplay();
                selectLocation(record.location);
                
                setTimeout(() => {
                    selectSite(record.site);
                    dispatchDateInput.value = record.date;
                    
                    // Remove the original record
                    dispatchRecords = dispatchRecords.filter(r => r.id !== id);
                    saveData();
                    updateSiteTotals();
                    renderDispatchRecords();
                    renderSiteTotals();
                    
                    // Show edit message
                    showEditMessage();
                    
                    // Scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 100);
            }, 100);
        }

        function removeRecord(id) {
            dispatchRecords = dispatchRecords.filter(record => record.id !== id);
            saveData(); // Save to localStorage
            updateSiteTotals();
            renderDispatchRecords();
            renderSiteTotals();
        }

        function showSuccessMessage() {
            const message = document.createElement('div');
            message.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            message.textContent = `‚úì ${selectedPlates.length} dispatch record${selectedPlates.length > 1 ? 's' : ''} added successfully!`;
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 3000);
        }

        function showEditMessage() {
            const message = document.createElement('div');
            message.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            message.textContent = '‚úèÔ∏è Record loaded for editing. Make changes and click Add to save.';
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 4000);
        }

        function showSiteDetails(siteKey) {
            const data = siteTotals[siteKey];
            if (!data) return;
            
            // Get all records for this site
            const siteRecords = dispatchRecords.filter(record => 
                `${record.location} - ${record.site}` === siteKey
            );
            
            // Count plates
            const plateCounts = {};
            siteRecords.forEach(record => {
                if (!plateCounts[record.plateNumber]) {
                    plateCounts[record.plateNumber] = {
                        count: 0,
                        truckType: record.truckType,
                        total: 0
                    };
                }
                plateCounts[record.plateNumber].count += 1;
                plateCounts[record.plateNumber].total += record.rate;
            });
            
            // Create modal content
            const plateDetails = Object.entries(plateCounts)
                .sort(([a], [b]) => a.localeCompare(b))
                .map(([plate, info]) => `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-lg">${plate}</span>
                            <span class="px-2 py-1 text-xs rounded-full ${info.truckType === 'denjo' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}">${info.truckType.toUpperCase()}</span>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg text-green-600">‚Ç±${info.total.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                            <div class="text-sm text-gray-600">${info.count} trips</div>
                        </div>
                    </div>
                `).join('');
            
            // Create and show modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">${data.location}</h3>
                                <p class="text-lg text-gray-600">${data.site}</p>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">√ó</button>
                        </div>
                    </div>
                    <div class="p-6">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">üìã Plate Numbers & Trip Counts</h4>
                        <div class="space-y-3 mb-6">
                            ${plateDetails}
                        </div>
                        <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-4 border border-purple-200">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-bold text-gray-700">SITE TOTAL:</span>
                                <span class="text-2xl font-bold text-purple-600">‚Ç±${data.total.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">${data.count} total trips ‚Ä¢ ${Object.keys(plateCounts).length} different plates</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                
                // If all fields are filled, add the dispatch record
                if (selectedPlates.length > 0 && selectedLocation && selectedSite && dispatchDateInput.value) {
                    addDispatchRecord();
                    return;
                }
                
                // Auto-select first matching plate if search has results
                const searchTerm = document.getElementById('plateSearch').value.toUpperCase();
                if (searchTerm && selectedPlates.length === 0) {
                    const denjoMatches = denjoPlates.filter(plate => 
                        plate.toUpperCase().includes(searchTerm)
                    );
                    const subconMatches = subconPlates.filter(plate => 
                        plate.toUpperCase().includes(searchTerm)
                    );
                    
                    let firstMatch = null;
                    if (denjoMatches.length > 0 && subconMatches.length === 0) {
                        firstMatch = denjoMatches[0];
                    } else if (subconMatches.length > 0 && denjoMatches.length === 0) {
                        firstMatch = subconMatches[0];
                    } else if (denjoMatches.length > 0 || subconMatches.length > 0) {
                        firstMatch = [...denjoMatches, ...subconMatches].sort()[0];
                    }
                    
                    if (firstMatch) {
                        togglePlateSelection(firstMatch);
                    }
                }
            }
        }

        // Multi-Site Functions
        function selectMultiTruckType(type) {
            multiSelectedTruckType = type;
            multiSelectedPlates = [];
            multiSelectedLocation = '';
            multiSelectedSites = [];
            
            // Update button styles
            document.getElementById('multiDenjoBtn').className = type === 'denjo' ? 
                'flex-1 p-4 border-2 border-blue-500 bg-blue-50 rounded-lg text-center font-semibold text-blue-700' :
                'flex-1 p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors text-center font-semibold';
            
            document.getElementById('multiSubconBtn').className = type === 'subcon' ? 
                'flex-1 p-4 border-2 border-green-500 bg-green-50 rounded-lg text-center font-semibold text-green-700' :
                'flex-1 p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors text-center font-semibold';
            
            // Show plate section
            document.getElementById('multiPlateSection').classList.remove('hidden');
            renderMultiPlateButtons();
            
            // Show location section
            const locationSection = document.getElementById('multiLocationSection');
            const locationButtons = document.getElementById('multiLocationButtons');
            locationSection.classList.remove('hidden');
            
            const rates = type === 'denjo' ? denjoRates : subconRates;
            locationButtons.innerHTML = Object.keys(rates).map(location => 
                `<button class="p-3 border border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-sm font-medium" onclick="selectMultiLocation('${location}')">${location}</button>`
            ).join('');
            
            // Hide site section initially
            document.getElementById('multiSiteSection').classList.add('hidden');
            
            updateMultiPreview();
        }

        function renderMultiPlateButtons(filteredPlates = null) {
            const plateButtons = document.getElementById('multiPlateButtons');
            const plates = filteredPlates || (multiSelectedTruckType === 'denjo' ? denjoPlates : subconPlates);
            
            if (plates.length === 0) {
                plateButtons.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">No plates found matching your search</div>';
                return;
            }
            
            plateButtons.innerHTML = plates.map(plate => 
                `<button class="${multiSelectedPlates.includes(plate) ? 'p-2 border-2 border-purple-500 bg-purple-50 rounded-lg text-sm font-medium text-purple-700' : 'p-2 border border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-sm font-medium'}" onclick="toggleMultiPlateSelection('${plate}')">${plate}</button>`
            ).join('');
        }

        function renderMixedMultiPlateButtons(denjoMatches, subconMatches) {
            const plateButtons = document.getElementById('multiPlateButtons');
            
            // Combine and sort all matches
            const allMatches = [...denjoMatches, ...subconMatches].sort();
            
            plateButtons.innerHTML = allMatches.map(plate => {
                const isDenjo = denjoMatches.includes(plate);
                const truckTypeColor = isDenjo ? 'blue' : 'green';
                const truckTypeLabel = isDenjo ? 'D' : 'S';
                const isSelected = multiSelectedPlates.includes(plate);
                
                return `<button class="${isSelected ? 'p-2 border-2 border-purple-500 bg-purple-50 rounded-lg text-sm font-medium text-purple-700' : `p-2 border border-gray-300 rounded-lg hover:border-${truckTypeColor}-500 hover:bg-${truckTypeColor}-50 transition-colors text-sm font-medium`}" onclick="selectMultiPlateWithType('${plate}', '${isDenjo ? 'denjo' : 'subcon'}')">
                    <div class="flex items-center justify-between">
                        <span>${plate}</span>
                        <span class="ml-1 px-1 py-0.5 text-xs rounded ${isDenjo ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}">${truckTypeLabel}</span>
                    </div>
                </button>`;
            }).join('');
        }

        function filterMultiPlates() {
            const searchTerm = document.getElementById('multiPlateSearch').value.toUpperCase();
            
            if (searchTerm.length === 0) {
                if (multiSelectedTruckType) {
                    renderMultiPlateButtons();
                } else {
                    // Show initial message when no truck type selected and no search
                    document.getElementById('multiPlateButtons').innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">Select truck type first or start typing to search</div>';
                }
                return;
            }
            
            // Search in both denjo and subcon plates regardless of selected truck type
            const denjoMatches = denjoPlates.filter(plate => 
                plate.toUpperCase().includes(searchTerm)
            );
            const subconMatches = subconPlates.filter(plate => 
                plate.toUpperCase().includes(searchTerm)
            );
            
            // Combine all matches and show them
            const allMatches = [...denjoMatches, ...subconMatches].sort();
            
            if (allMatches.length === 0) {
                // No matches found
                renderMultiPlateButtons([]);
                return;
            }
            
            // Auto-detect and set truck type if only one type has matches
            if (denjoMatches.length > 0 && subconMatches.length === 0) {
                // Only Denjo matches found
                if (multiSelectedTruckType !== 'denjo') {
                    selectMultiTruckType('denjo');
                }
                renderMultiPlateButtons(denjoMatches);
            } else if (subconMatches.length > 0 && denjoMatches.length === 0) {
                // Only Subcon matches found
                if (multiSelectedTruckType !== 'subcon') {
                    selectMultiTruckType('subcon');
                }
                renderMultiPlateButtons(subconMatches);
            } else {
                // Both types have matches - show all with type indicators
                renderMixedMultiPlateButtons(denjoMatches, subconMatches);
            }
        }

        function toggleMultiPlateSelection(plate) {
            if (multiSelectedPlates.includes(plate)) {
                multiSelectedPlates = multiSelectedPlates.filter(p => p !== plate);
            } else {
                multiSelectedPlates.push(plate);
            }
            
            updateMultiSelectedPlatesDisplay();
            renderMultiPlateButtons();
            updateMultiPreview();
        }

        function selectMultiPlateWithType(plate, truckType) {
            // Auto-select truck type if not already selected or if different
            if (multiSelectedTruckType !== truckType) {
                selectMultiTruckType(truckType);
            }
            
            // Add plate to selection
            if (!multiSelectedPlates.includes(plate)) {
                multiSelectedPlates.push(plate);
            }
            
            // Clear search input after selecting a plate
            document.getElementById('multiPlateSearch').value = '';
            
            // Reset plate buttons to show all available plates for current truck type
            renderMultiPlateButtons();
            
            // Update displays
            updateMultiSelectedPlatesDisplay();
            updateMultiPreview();
        }

        function updateMultiSelectedPlatesDisplay() {
            const display = document.getElementById('multiSelectedPlatesDisplay');
            const list = document.getElementById('multiSelectedPlatesList');
            
            if (multiSelectedPlates.length === 0) {
                display.classList.add('hidden');
                return;
            }
            
            display.classList.remove('hidden');
            list.innerHTML = multiSelectedPlates.map(plate => 
                `<span class="inline-flex items-center gap-1 px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium">
                    ${plate}
                    <button onclick="removeMultiPlateFromSelection('${plate}')" class="text-purple-500 hover:text-purple-700 ml-1">√ó</button>
                </span>`
            ).join('');
        }

        function removeMultiPlateFromSelection(plate) {
            multiSelectedPlates = multiSelectedPlates.filter(p => p !== plate);
            updateMultiSelectedPlatesDisplay();
            renderMultiPlateButtons();
            updateMultiPreview();
        }

        function clearAllMultiSelectedPlates() {
            multiSelectedPlates = [];
            updateMultiSelectedPlatesDisplay();
            renderMultiPlateButtons();
            updateMultiPreview();
        }

        function selectMultiLocation(location) {
            multiSelectedLocation = location;
            
            // Update location button styles
            const rates = multiSelectedTruckType === 'denjo' ? denjoRates : subconRates;
            const locationButtons = document.getElementById('multiLocationButtons');
            locationButtons.innerHTML = Object.keys(rates).map(loc => {
                // Check if this location has selected sites
                const hasSelectedSites = multiSitesByLocation[loc] && multiSitesByLocation[loc].length > 0;
                const siteCount = hasSelectedSites ? multiSitesByLocation[loc].length : 0;
                const baseClass = 'p-3 border rounded-lg text-sm font-medium transition-colors';
                
                if (loc === location) {
                    return `<button class="${baseClass} border-2 border-purple-500 bg-purple-50 text-purple-700" onclick="selectMultiLocation('${loc}')">${loc}${hasSelectedSites ? ` ‚úì(${siteCount})` : ''}</button>`;
                } else if (hasSelectedSites) {
                    return `<button class="${baseClass} border-2 border-green-400 bg-green-50 text-green-700 hover:border-purple-500 hover:bg-purple-50" onclick="selectMultiLocation('${loc}')">${loc} ‚úì(${siteCount})</button>`;
                } else {
                    return `<button class="${baseClass} border-gray-300 hover:border-purple-500 hover:bg-purple-50" onclick="selectMultiLocation('${loc}')">${loc}</button>`;
                }
            }).join('');
            
            // Show and populate site section
            const siteSection = document.getElementById('multiSiteSection');
            const siteButtons = document.getElementById('multiSiteButtons');
            siteSection.classList.remove('hidden');
            
            if (locationSites[location]) {
                // Get previously selected sites for this location with counts
                const selectedSitesForLocation = multiSitesByLocation[location] || [];
                
                siteButtons.innerHTML = locationSites[location].map(site => {
                    const siteCount = selectedSitesForLocation.filter(siteObj => siteObj.site === site).length;
                    const isSelected = siteCount > 0;
                    const countText = siteCount > 1 ? ` (${siteCount})` : '';
                    return `<button class="${isSelected ? 'p-2 border-2 border-purple-500 bg-purple-50 rounded-lg text-sm font-medium text-purple-700' : 'p-2 border border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-sm font-medium'}" onclick="toggleMultiSiteSelection('${site}')">${site}${countText}</button>`;
                }).join('');
            }
            
            updateMultiSelectedSitesDisplay();
            updateMultiPreview();
        }

        function toggleMultiSiteSelection(site) {
            // Initialize location array if it doesn't exist
            if (!multiSitesByLocation[multiSelectedLocation]) {
                multiSitesByLocation[multiSelectedLocation] = [];
            }
            
            // Always add the site (allow multiple selections of same site)
            const today = new Date().toISOString().split('T')[0];
            multiSitesByLocation[multiSelectedLocation].push({
                site: site,
                date: today,
                id: Date.now() + Math.random() // Unique ID for each selection
            });
            
            // Update global multiSelectedSites array with all sites from all locations
            multiSelectedSites = [];
            Object.values(multiSitesByLocation).forEach(sites => {
                sites.forEach(siteObj => {
                    multiSelectedSites.push(siteObj.site);
                });
            });
            
            // Update site button styles for current location - show count if multiple selections
            const siteButtons = document.getElementById('multiSiteButtons');
            siteButtons.innerHTML = locationSites[multiSelectedLocation].map(s => {
                const siteCount = multiSitesByLocation[multiSelectedLocation].filter(siteObj => siteObj.site === s).length;
                const isSelected = siteCount > 0;
                const countText = siteCount > 1 ? ` (${siteCount})` : '';
                return `<button class="${isSelected ? 'p-2 border-2 border-purple-500 bg-purple-50 rounded-lg text-sm font-medium text-purple-700' : 'p-2 border border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-sm font-medium'}" onclick="toggleMultiSiteSelection('${s}')">${s}${countText}</button>`;
            }).join('');
            
            // Update location buttons to show checkmarks
            selectMultiLocation(multiSelectedLocation);
            
            updateMultiSelectedSitesDisplay();
            updateMultiPreview();
        }

        function updateMultiSelectedSitesDisplay() {
            const display = document.getElementById('multiSelectedSitesDisplay');
            const list = document.getElementById('multiSelectedSitesList');
            
            if (multiSelectedSites.length === 0) {
                display.classList.add('hidden');
                return;
            }
            
            display.classList.remove('hidden');
            
            // Group sites by location for display
            let displayHTML = '';
            Object.entries(multiSitesByLocation).forEach(([location, sites]) => {
                if (sites.length > 0) {
                    displayHTML += `<div class="w-full mb-4 p-3 bg-white rounded-lg border border-gray-200">
                        <div class="text-sm font-bold text-gray-700 mb-3">${location} (${sites.length} entries):</div>
                        <div class="space-y-2">
                            ${sites.map((siteObj, index) => 
                                `<div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                                    <div class="flex-1">
                                        <span class="font-medium text-gray-800">${siteObj.site}</span>
                                        <span class="text-xs text-gray-500 ml-2">#${index + 1}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="date" value="${siteObj.date}" 
                                               onchange="updateSiteDate('${location}', ${index}, this.value)"
                                               class="px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                        <button onclick="removeSpecificSiteEntry('${location}', ${index})" 
                                                class="text-red-500 hover:text-red-700 font-bold text-lg">√ó</button>
                                    </div>
                                </div>`
                            ).join('')}
                        </div>
                    </div>`;
                }
            });
            
            list.innerHTML = displayHTML;
        }

        function updateSiteDate(location, siteIndex, newDate) {
            if (multiSitesByLocation[location] && multiSitesByLocation[location][siteIndex]) {
                multiSitesByLocation[location][siteIndex].date = newDate;
                updateMultiPreview();
            }
        }

        function removeSpecificSiteEntry(location, index) {
            // Remove specific entry by index
            if (multiSitesByLocation[location] && multiSitesByLocation[location][index]) {
                multiSitesByLocation[location].splice(index, 1);
            }
            
            // Update global multiSelectedSites array
            multiSelectedSites = [];
            Object.values(multiSitesByLocation).forEach(sites => {
                sites.forEach(siteObj => {
                    multiSelectedSites.push(siteObj.site);
                });
            });
            
            // If we're currently viewing this location, update the site buttons
            if (multiSelectedLocation === location) {
                const siteButtons = document.getElementById('multiSiteButtons');
                siteButtons.innerHTML = locationSites[multiSelectedLocation].map(s => {
                    const siteCount = multiSitesByLocation[multiSelectedLocation].filter(siteObj => siteObj.site === s).length;
                    const isSelected = siteCount > 0;
                    const countText = siteCount > 1 ? ` (${siteCount})` : '';
                    return `<button class="${isSelected ? 'p-2 border-2 border-purple-500 bg-purple-50 rounded-lg text-sm font-medium text-purple-700' : 'p-2 border border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-sm font-medium'}" onclick="toggleMultiSiteSelection('${s}')">${s}${countText}</button>`;
                }).join('');
            }
            
            // Update location buttons to show/hide checkmarks
            selectMultiLocation(multiSelectedLocation);
            
            updateMultiSelectedSitesDisplay();
            updateMultiPreview();
        }

        function removeMultiSiteFromSelection(site, location) {
            // Remove ALL entries of this site from specific location
            if (multiSitesByLocation[location]) {
                multiSitesByLocation[location] = multiSitesByLocation[location].filter(siteObj => siteObj.site !== site);
            }
            
            // Update global multiSelectedSites array
            multiSelectedSites = [];
            Object.values(multiSitesByLocation).forEach(sites => {
                sites.forEach(siteObj => {
                    multiSelectedSites.push(siteObj.site);
                });
            });
            
            // If we're currently viewing this location, update the site buttons
            if (multiSelectedLocation === location) {
                const siteButtons = document.getElementById('multiSiteButtons');
                siteButtons.innerHTML = locationSites[multiSelectedLocation].map(s => {
                    const siteCount = multiSitesByLocation[multiSelectedLocation].filter(siteObj => siteObj.site === s).length;
                    const isSelected = siteCount > 0;
                    const countText = siteCount > 1 ? ` (${siteCount})` : '';
                    return `<button class="${isSelected ? 'p-2 border-2 border-purple-500 bg-purple-50 rounded-lg text-sm font-medium text-purple-700' : 'p-2 border border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-sm font-medium'}" onclick="toggleMultiSiteSelection('${s}')">${s}${countText}</button>`;
                }).join('');
            }
            
            // Update location buttons to show/hide checkmarks
            selectMultiLocation(multiSelectedLocation);
            
            updateMultiSelectedSitesDisplay();
            updateMultiPreview();
        }

        function clearAllMultiSelectedSites() {
            multiSelectedSites = [];
            multiSitesByLocation = {};
            
            // Update site button styles for current location
            if (multiSelectedLocation && locationSites[multiSelectedLocation]) {
                const siteButtons = document.getElementById('multiSiteButtons');
                siteButtons.innerHTML = locationSites[multiSelectedLocation].map(site => 
                    `<button class="p-2 border border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-sm font-medium" onclick="toggleMultiSiteSelection('${site}')">${site}</button>`
                ).join('');
            }
            
            // Update location buttons to remove checkmarks
            if (multiSelectedLocation) {
                selectMultiLocation(multiSelectedLocation);
            }
            
            updateMultiSelectedSitesDisplay();
            updateMultiPreview();
        }

        function updateMultiPreview() {
            if (!multiSelectedTruckType || multiSelectedPlates.length === 0 || multiSelectedSites.length === 0) {
                multiRecordCountDiv.textContent = '0 records';
                multiTotalAmountDiv.textContent = '‚Ç±0.00';
                addMultiDispatchBtn.disabled = true;
                return;
            }

            const rates = multiSelectedTruckType === 'denjo' ? denjoRates : subconRates;
            
            // Calculate total records and amount across all locations
            let totalRecords = 0;
            let totalAmount = 0;
            
            Object.entries(multiSitesByLocation).forEach(([location, sites]) => {
                const locationRate = rates[location] || 0;
                const locationRecords = multiSelectedPlates.length * sites.length;
                totalRecords += locationRecords;
                totalAmount += locationRecords * locationRate;
            });
            
            multiRecordCountDiv.textContent = `${totalRecords} records`;
            multiTotalAmountDiv.textContent = `‚Ç±${totalAmount.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
            
            // Enable button if all fields are filled (no need for date check since each site has its own date)
            const allFieldsFilled = multiSelectedPlates.length > 0 && multiSelectedSites.length > 0;
            addMultiDispatchBtn.disabled = !allFieldsFilled;
        }

        function addMultiDispatchRecord() {
            const rates = multiSelectedTruckType === 'denjo' ? denjoRates : subconRates;

            // Create a record for each combination of plate and site (across all locations)
            multiSelectedPlates.forEach(plate => {
                Object.entries(multiSitesByLocation).forEach(([location, sites]) => {
                    sites.forEach(siteObj => {
                        const record = {
                            id: Date.now() + Math.random(),
                            truckType: multiSelectedTruckType,
                            plateNumber: plate,
                            location: location,
                            site: siteObj.site,
                            date: siteObj.date,
                            rate: rates[location]
                        };
                        dispatchRecords.push(record);
                    });
                });
            });

            saveData();
            updateSiteTotals();
            renderDispatchRecords();
            renderSiteTotals();
            
            // Reset multi form
            resetMultiForm();
            
            // Show success message
            showMultiSuccessMessage();
        }

        function resetMultiForm() {
            multiSelectedTruckType = '';
            multiSelectedPlates = [];
            multiSelectedLocation = '';
            multiSelectedSites = [];
            multiSitesByLocation = {};
            
            // Reset truck type buttons
            document.getElementById('multiDenjoBtn').className = 'flex-1 p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors text-center font-semibold';
            document.getElementById('multiSubconBtn').className = 'flex-1 p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors text-center font-semibold';
            
            // Clear search input
            document.getElementById('multiPlateSearch').value = '';
            
            // Hide sections
            document.getElementById('multiPlateSection').classList.add('hidden');
            document.getElementById('multiLocationSection').classList.add('hidden');
            document.getElementById('multiSiteSection').classList.add('hidden');
            
            // Hide selected displays
            updateMultiSelectedPlatesDisplay();
            updateMultiSelectedSitesDisplay();
            
            // Reset preview and button
            multiRecordCountDiv.textContent = '0 records';
            multiTotalAmountDiv.textContent = '‚Ç±0.00';
            addMultiDispatchBtn.disabled = true;
        }

        function showMultiSuccessMessage() {
            const totalRecords = multiSelectedPlates.length * multiSelectedSites.length;
            const message = document.createElement('div');
            message.className = 'fixed top-4 right-4 bg-purple-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            message.textContent = `‚úì ${totalRecords} dispatch records created successfully!`;
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 3000);
        }

        // Initialize
        updateRate();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97ee0f7f3489fecc',t:'MTc1NzgzMzc4NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
