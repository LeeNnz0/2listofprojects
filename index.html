<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truck Dispatch System</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-6">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">üöõ Truck Dispatch System</h1>
            
            <!-- Selection Form -->
            <div class="space-y-6 mb-8">
                <!-- Truck Type Selection -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Select Truck Type</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <button id="denjoBtn" class="p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors text-center font-semibold" onclick="selectTruckType('denjo')">
                            üöõ Denjo Trucks
                        </button>
                        <button id="denjoDumpBtn" class="p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors text-center font-semibold" onclick="selectTruckType('denjo_dump')">
                            üöõ Denjo Dump Trucks
                        </button>
                        <button id="subconBtn" class="p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors text-center font-semibold" onclick="selectTruckType('subcon')">
                            üöö Subcon Trucks
                        </button>
                        <button id="subconDumpBtn" class="p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors text-center font-semibold" onclick="selectTruckType('subcon_dump')">
                            üöö Subcon Dump Trucks
                        </button>
                    </div>
                </div>

                <!-- Plate Number Search (Always Visible) -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Search Plate Number</label>
                    
                    <!-- Manual Search Input -->
                    <div class="mb-4">
                        <input type="text" id="plateSearch" placeholder="Type plate number to search (e.g. 'NK' or 'AAV')..." 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                               oninput="filterPlates()" onkeypress="handleEnterKey(event)">
                        <div class="text-xs text-gray-500 mt-1">üí° Start typing - truck type will be detected automatically! Click plates to select multiple.</div>
                    </div>
                    
                    <!-- Selected Plates Display -->
                    <div id="selectedPlatesDisplay" class="hidden mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-semibold text-green-700">Selected Plates with Quantities:</span>
                            <button onclick="clearAllSelectedPlates()" class="text-xs text-red-500 hover:text-red-700 font-semibold">Clear All</button>
                        </div>
                        <div class="text-xs text-gray-600 mb-3">üí° Click + or - to adjust how many times each plate visited the site!</div>
                        <div id="selectedPlatesList" class="space-y-2">
                        </div>
                    </div>
                    
                    <div id="plateButtons" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
                        <div class="col-span-full text-center text-gray-500 py-4">Start typing to see matching plate numbers</div>
                    </div>
                </div>

                <!-- Location Selection -->
                <div id="locationSection" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Select Location</label>
                    <div id="locationButtons" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                    </div>
                </div>

                <!-- Site Selection -->
                <div id="siteSection" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Select Site</label>
                    <div id="siteButtons" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
                    </div>
                </div>

                <!-- Date and Rate -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Date</label>
                        <input type="date" id="dispatchDate" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-sm font-semibold text-gray-700 mb-1">Current Rate</div>
                        <div id="currentRate" class="text-2xl font-bold text-blue-600">‚Ç±0.00</div>
                    </div>
                </div>
            </div>
            
            <div class="space-y-3">
                <button id="addDispatch" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                    Add Dispatch Entry
                </button>
                
                <!-- Data Recovery Section -->
                <div class="flex gap-2">
                    <button onclick="exportData()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 text-sm">
                        üíæ Export Data
                    </button>
                    <button onclick="importData()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 text-sm">
                        üìÇ Import Data
                    </button>
                    <button onclick="showDataStatus()" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 text-sm">
                        üìä Data Status
                    </button>
                </div>
                
                <!-- Add Custom Plate Section -->
                <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h3 class="text-lg font-bold text-yellow-800 mb-3">üöõ Add Custom Plate Number</h3>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="customPlateInput" placeholder="Enter new plate number (e.g., ABC 1234)" 
                               class="flex-1 p-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-sm"
                               onkeypress="handleCustomPlateEnter(event)">
                        <select id="customPlateType" class="p-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-sm">
                            <option value="">Select Type</option>
                            <option value="denjo">üöõ Denjo Truck</option>
                            <option value="denjo_dump">üöõ Denjo Dump Truck</option>
                            <option value="subcon">üöö Subcon Truck</option>
                            <option value="subcon_dump">üöö Subcon Dump Truck</option>
                        </select>
                        <button onclick="addCustomPlate()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 text-sm">
                            ‚ûï Add
                        </button>
                    </div>
                    <div class="text-xs text-yellow-700">üí° Add new plate numbers that aren't in the system yet. They'll be saved permanently!</div>
                </div>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleFileImport(event)">
            </div>
        </div>
        
        <!-- Multi-Site Dispatch Section -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-6 border-2 border-purple-200">
            <h2 class="text-2xl font-bold text-purple-800 mb-6">üöõ‚û°Ô∏èüè¢ Multi-Site Dispatch</h2>
            <p class="text-sm text-gray-600 mb-6">Perfect for when the same plates visit multiple sites! Select plates once, then pick all the sites they visited.</p>
            
            <div class="space-y-6">
                <!-- Multi Truck Type Selection -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Select Truck Type</label>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <button id="multiDenjoBtn" class="p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors text-center font-semibold" onclick="selectMultiTruckType('denjo')">
                            üöõ Denjo Trucks
                        </button>
                        <button id="multiDenjoDumpBtn" class="p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors text-center font-semibold" onclick="selectMultiTruckType('denjo_dump')">
                            üöõ Denjo Dump Trucks
                        </button>
                        <button id="multiSubconBtn" class="p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors text-center font-semibold" onclick="selectMultiTruckType('subcon')">
                            üöö Subcon Trucks
                        </button>
                        <button id="multiSubconDumpBtn" class="p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors text-center font-semibold" onclick="selectMultiTruckType('subcon_dump')">
                            üöö Subcon Dump Trucks
                        </button>
                    </div>
                </div>

                <!-- Multi Plate Search -->
                <div id="multiPlateSection" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Search & Select Multiple Plates</label>
                    
                    <div class="mb-4">
                        <input type="text" id="multiPlateSearch" placeholder="Type plate number to search..." 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                               oninput="filterMultiPlates()">
                        <div class="text-xs text-gray-500 mt-1">üí° Click multiple plates to select them all at once!</div>
                    </div>
                    
                    <!-- Multi Selected Plates Display -->
                    <div id="multiSelectedPlatesDisplay" class="hidden mb-4 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-semibold text-purple-700">Selected Plates:</span>
                            <button onclick="clearAllMultiSelectedPlates()" class="text-xs text-red-500 hover:text-red-700 font-semibold">Clear All</button>
                        </div>
                        <div id="multiSelectedPlatesList" class="flex flex-wrap gap-2">
                        </div>
                    </div>
                    
                    <div id="multiPlateButtons" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2 mb-6">
                        <div class="col-span-full text-center text-gray-500 py-4">Select truck type first</div>
                    </div>
                </div>

                <!-- Multi Location & Sites Selection -->
                <div id="multiLocationSection" class="hidden">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Select Location</label>
                    <div id="multiLocationButtons" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 mb-6">
                    </div>
                    
                    <div id="multiSiteSection" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Select Multiple Sites</label>
                        <div class="text-xs text-gray-500 mb-3">üí° Click multiple sites - each selected plate will be recorded for each selected site!</div>
                        
                        <!-- Multi Selected Sites Display -->
                        <div id="multiSelectedSitesDisplay" class="hidden mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-semibold text-blue-700">Selected Sites with Dates:</span>
                                <button onclick="clearAllMultiSelectedSites()" class="text-xs text-red-500 hover:text-red-700 font-semibold">Clear All</button>
                            </div>
                            <div class="text-xs text-gray-600 mb-3">üí° Click on any site below to change its date!</div>
                            <div id="multiSelectedSitesList" class="space-y-2">
                            </div>
                        </div>
                        
                        <div id="multiSiteButtons" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-2">
                        </div>
                    </div>
                </div>

                <!-- Multi Preview -->
                <div class="bg-purple-50 p-4 rounded-lg">
                    <div class="text-sm font-semibold text-gray-700 mb-1">Total Records to Create</div>
                    <div id="multiRecordCount" class="text-2xl font-bold text-purple-600">0 records</div>
                    <div id="multiTotalAmount" class="text-lg font-semibold text-green-600">‚Ç±0.00</div>
                </div>
            </div>
            
            <button id="addMultiDispatch" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed mt-6" disabled>
                Create All Dispatch Records
            </button>
        </div>
        
        <!-- Site Totals -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">üè¢ Site Totals</h2>
                <button onclick="generateReport()" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 flex items-center gap-2">
                    üñ®Ô∏è Generate Report
                </button>
            </div>
            <div id="siteTotals" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="text-gray-500 text-center py-8 col-span-full">No sites added yet. Add dispatch entries to see totals!</div>
            </div>
        </div>

        <!-- Dispatch Records -->
        <div class="bg-white rounded-xl shadow-lg p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">üìã Dispatch Records</h2>
            <div id="dispatchRecords" class="space-y-4">
                <div class="text-gray-500 text-center py-8">No dispatch records yet. Add your first entry above!</div>
            </div>
        </div>
    </div>

    <script>
        // Data - Base plates (original system plates)
        const baseDenjoPlates = [
            'AAV 3315', 'ABD 2336', 'CAE 8359', 'MAK 4606', 'MAL 7663', 'NAJ 6390', 
            'NAM 7981', 'NAM 7982', 'NAX 5523', 'NAZ 1509', 'NBA 1561', 'NBA 1570', 
            'NBA 1573', 'NBA 1574', 'NDH 2626', 'NDM 3414', 'NDM 4083', 'NFZ 2650', 
            'NFZ 2658', 'NGB 1550', 'NIF 1814', 'NKF 1653', 'NKF 1663'
        ];

        const baseSubconPlates = [
            'ABH 293', 'ALA 7244', 'CAG 1899', 'CBP 881', 'KAS 6089', 'KAT 4965',
            'MBF 6760', 'MBI 5795', 'MV 2253', 'MV 3160', 'NCK 6502', 'NES 3903', 'NES 7099', 
            'NES 9440', 'NFO 1978', 'NFQ 1221', 'NFV 8013', 'NFX 7968', 'NGB 3188', 'NGF 1435', 
            'NGR 4654', 'NGL 9012', 'NID 4886', 'NII 253', 'NIK 7805', 'NKR 4609', 
            'NKR 4879', 'NKR 5126', 'NKR 5127', 'NKR 5128', 'NKR 5129', 'NKR 5130', 'NKR 5131', 'NQE 393', 'RFC 991', 
            'RGZ 134', 'RME 481', 'RMJ 498', 'RNE 172', 'WMZ 181'
        ];

        // Custom plates storage
        let customDenjoPlates = [];
        let customDenjoDumpPlates = [];
        let customSubconPlates = [];
        let customSubconDumpPlates = [];

        // Combined plates arrays (base + custom)
        let denjoPlates = [];
        let denjoDumpPlates = [];
        let subconPlates = [];
        let subconDumpPlates = [];

        const denjoRates = {
            'ALABANG': 3928.57,
            'BGC/TAGUIG': 3482.14,
            'BICUTAN': 3705.36,
            'CALOOCAN': 4107.14,
            'CUBAO': 3928.57,
            'FTI/ARCA SOUTH': 2857.14,
            'LAS PINAS': 3928.57,
            'MAKATI': 3348.21,
            'MALABON': 4107.14,
            'MANDALUYONG': 3660.71,
            'MANILA': 4017.14,
            'MUNTINLUPA': 3923.21,
            'PARANAQUE': 3883.93,
            'PASAY': 3928.57,
            'PASIG': 3750,
            'QC': 3928.57,
            'SUCAT': 3839.29,
            'VALENZUELA': 4821.43
        };

        const subconRates = {
            'ALABANG': 2000,
            'ARCA SOUTH/FTI': 1600,
            'FTI/ARCA SOUTH': 1600,
            'ASEANA': 1900,
            'BBG': 1600,
            'BGC/TAGUIG': 1600,
            'CAVITE': 2300,
            'FAIRVIEW': 2000,
            'MAKATI': 1700,
            'MANDALUYONG': 1900,
            'MANILA': 2000,
            'NUVALI': 2300,
            'PARANAQUE': 1900,
            'PASAY': 1700,
            'PASIG': 1700,
            'QC': 2000
        };

        const denjoDumpRates = {
            'ALABANG': 5500,
            'BGC/TAGUIG': 4800,
            'BICUTAN': 5200,
            'CALOOCAN': 5700,
            'CUBAO': 5500,
            'FTI/ARCA SOUTH': 4000,
            'LAS PINAS': 5500,
            'MAKATI': 4700,
            'MALABON': 5700,
            'MANDALUYONG': 5100,
            'MANILA': 5600,
            'MUNTINLUPA': 5500,
            'PARANAQUE': 5400,
            'PASAY': 5500,
            'PASIG': 5200,
            'QC': 5500,
            'SUCAT': 5300,
            'VALENZUELA': 6700
        };

        const subconDumpRates = {
            'ALABANG': 2800,
            'ARCA SOUTH/FTI': 2200,
            'FTI/ARCA SOUTH': 2200,
            'ASEANA': 2600,
            'BBG': 2200,
            'BGC/TAGUIG': 2200,
            'CAVITE': 3200,
            'FAIRVIEW': 2800,
            'MAKATI': 2400,
            'MANDALUYONG': 2600,
            'MANILA': 2800,
            'NUVALI': 3200,
            'PARANAQUE': 2600,
            'PASAY': 2400,
            'PASIG': 2400,
            'QC': 2800
        };

        const locationSites = {
            'ALABANG': [
                'AMAIA STEPS ALABANG',
                'AVIDA SUCAT',
                'AVIDA TOWERS ARDANE T1',
                'NUEVO T1 (CERCA B3 T1)',
                'VIENTO T3'
            ].sort(),
            'ARCA SOUTH/FTI': [
                'ARBOR LANES PHASE 3 BLOCK 4',
                'ARBOR LANES PHASE 3 BLOCK 5',
                'ARCA SOUTH PIE MALL',
                'ARCA SOUTH PIE P1 BPO 1 (AGB) (1G2)',
                'ARCA YARD',
                'GARDENCOURT RESIDENCES ‚Äì MOLAVE',
                'GARDENCOURT RESIDENCES ‚Äì NARRA',
                'INTEGRATED BASEMENT PARKING',
                'INTERACTIVE PARK',
                'PARK CASCADES 1',
                'PARK CASCADES B2 G B3',
                'SEDA ARCA SOUTH',
                'TR YNE ENTERPRISE PLAZA (XAVIER B1)',
                'TR YNE PHASE 2',
                'VERANDA',
                'VIREO'
            ].sort(),
            'FTI/ARCA SOUTH': [
                'ARBOR LANES PHASE 3 BLOCK 4',
                'ARBOR LANES PHASE 3 BLOCK 5',
                'ARCA SOUTH PIE MALL',
                'ARCA SOUTH PIE P1 BPO 1 (AGB) (1G2)',
                'ARCA YARD',
                'GARDENCOURT RESIDENCES ‚Äì MOLAVE',
                'GARDENCOURT RESIDENCES ‚Äì NARRA',
                'INTEGRATED BASEMENT PARKING',
                'INTERACTIVE PARK',
                'PARK CASCADES 1',
                'PARK CASCADES B2 G B3',
                'SEDA ARCA SOUTH',
                'TR YNE ENTERPRISE PLAZA (XAVIER B1)',
                'TR YNE PHASE 2',
                'VERANDA',
                'VIREO'
            ].sort(),
            'ASEANA': ['Site ASE1', 'Site ASE2'].sort(),
            'BBG': ['Site BBG1', 'Site BBG2'].sort(),
            'BGC/TAGUIG': [
                'PARK EAST PLACE (MACE)',
                'PARK TRIANGLE MALL (CHEWEE)',
                'PARK TRIANGLE MALL (LIGHTSABER)',
                'VERVE 1'
            ].sort(),
            'BICUTAN': ['Site B1', 'Site B2'].sort(),
            'CALOOCAN': ['Site C1', 'Site C2'].sort(),
            'CAVITE': ['Site CV1', 'Site CV2', 'Site CV3'].sort(),
            'CUBAO': ['Site CB1', 'Site CB2', 'Site CB3'].sort(),
            'FAIRVIEW': ['Site FV1', 'Site FV2'].sort(),
            'FTI/ARCA SOUTH': [
                'ARBOR LANES PHASE 3 BLOCK 4',
                'ARBOR LANES PHASE 3 BLOCK 5',
                'ARCA SOUTH PIE MALL',
                'ARCA SOUTH PIE P1 BPO 1 (AGB) (1G2)',
                'ARCA YARD',
                'GARDENCOURT RESIDENCES ‚Äì MOLAVE',
                'GARDENCOURT RESIDENCES ‚Äì NARRA',
                'INTEGRATED BASEMENT PARKING',
                'INTERACTIVE PARK',
                'PARK CASCADES 1',
                'PARK CASCADES B2 G B3',
                'SEDA ARCA SOUTH',
                'TR YNE ENTERPRISE PLAZA (XAVIER B1)',
                'TR YNE PHASE 2',
                'VERANDA',
                'VIREO'
            ].sort(),
            'LAS PINAS': ['Site LP1', 'Site LP2'].sort(),
            'MAKATI': [
                'ASTELA T1 (CIRCUIT T5)',
                'ASTELA T1 + PODIUM',
                'AYALA MALLS GLORIETA',
                'BPI HQ REDEVELOPMENT',
                'CALLISTO 1',
                'CALLISTO 2',
                'CIRCUIT FLATS',
                'GENTRY PLAZA',
                'GENTRY RESIDENTIAL',
                'GLORIETA REINVENTION',
                'GREENBELT 1 REDEVELOPMENT',
                'GREENBELT REINVENTION',
                'HOLIDAY INN',
                'LEGACY (VARIOUS PROJECT)',
                'LTG LAND DEVELOPMENT AT MAKATI',
                'MANDARIN ORIENTAL (ATG)',
                'MERGENT RESIDENCES PHASE 1',
                'MERGENT T1 + PODIUM',
                'METROBANK',
                'ONE AYALA AVE',
                'PARK CENTRAL NORTH',
                'PARK CENTRAL SOUTH',
                'PARK VILLAS',
                'PARKFORD SUITES',
                'PARKFORD SUITES (LIFESAVER) AT MAKATI',
                'PARKFORD SUITES 3',
                'SEDA OAA (ORA SEDA HOTEL)',
                'SHATTER SHY',
                'SOUTHPOINT T2',
                'SOUTHPOINT T3'
            ].sort(),
            'MALABON': ['Site ML1', 'Site ML2'].sort(),
            'MANDALUYONG': [
                'AMAIA SHAW',
                'AVIDA TOWERS VERGE T2'
            ].sort(),
            'MANILA': [
                'AMAIA SKIES AVENIDA'
            ].sort(),
            'MUNTINLUPA': ['Site MT1', 'Site MT2'].sort(),
            'NUVALI': ['Site NV1', 'Site NV2'].sort(),
            'PARANAQUE': [
                'AYALA MALLS MANILA BAY'
            ].sort(),
            'PASAY': [
                'AVIDA CENTRALIS (PRIME TAFT T4)',
                'PATIO MADRIGAL T1'
            ].sort(),
            'PASIG': [
                'PARKLINKS (BLOOM)',
                'THE AMERITNE AT PORTICO',
                'THE LATTICE'
            ].sort(),
            'QC': [
                'ALP PARKLINKS NORTH (MANGO BRAVO)',
                'ALP PARKLINKS SOUTH',
                'AMAIA SKIES CUBAO T3',
                'AMAIA STEP THE JUCTION PLACE CLARA',
                'AMAIA STEPS JUNCTION DELICIA',
                'OREAN PLACE 1',
                'OREAN PLACE 2',
                'PARKLINKS MALL',
                'TRINOMA EXPANSION',
                'VERTIS NORTH HYDRA',
                'VERTIS NORTH PH1 T4 BPO',
                'VERTIS NORTH PH1 T5 BPO'
            ].sort(),
            'SUCAT': ['Site S1', 'Site S2'].sort(),
            'VALENZUELA': ['Site V1', 'Site V2'].sort()
        };

        let dispatchRecords = [];
        let siteTotals = {};
        let selectedTruckType = '';
        let selectedPlates = {}; // Changed to object to store quantities: {plateNumber: quantity}
        let selectedLocation = '';
        let selectedSite = '';

        // Multi-site variables
        let multiSelectedTruckType = '';
        let multiSelectedPlates = [];
        let multiSelectedLocation = '';
        let multiSelectedSites = [];
        let multiSitesByLocation = {}; // Track sites by location with dates: {location: [{site: 'siteName', date: 'YYYY-MM-DD'}]}

        // DOM elements
        const dispatchDateInput = document.getElementById('dispatchDate');
        const currentRateDiv = document.getElementById('currentRate');
        const addDispatchBtn = document.getElementById('addDispatch');
        const dispatchRecordsDiv = document.getElementById('dispatchRecords');
        const siteTotalsDiv = document.getElementById('siteTotals');
        
        // Multi-site DOM elements
        const addMultiDispatchBtn = document.getElementById('addMultiDispatch');
        const multiRecordCountDiv = document.getElementById('multiRecordCount');
        const multiTotalAmountDiv = document.getElementById('multiTotalAmount');

        // Load custom plates from localStorage
        function loadCustomPlates() {
            try {
                const savedDenjoPlates = localStorage.getItem('customDenjoPlates');
                const savedDenjoDumpPlates = localStorage.getItem('customDenjoDumpPlates');
                const savedSubconPlates = localStorage.getItem('customSubconPlates');
                const savedSubconDumpPlates = localStorage.getItem('customSubconDumpPlates');
                
                if (savedDenjoPlates) {
                    customDenjoPlates = JSON.parse(savedDenjoPlates);
                    console.log('‚úÖ Loaded', customDenjoPlates.length, 'custom Denjo plates');
                }
                
                if (savedDenjoDumpPlates) {
                    customDenjoDumpPlates = JSON.parse(savedDenjoDumpPlates);
                    console.log('‚úÖ Loaded', customDenjoDumpPlates.length, 'custom Denjo Dump plates');
                }
                
                if (savedSubconPlates) {
                    customSubconPlates = JSON.parse(savedSubconPlates);
                    console.log('‚úÖ Loaded', customSubconPlates.length, 'custom Subcon plates');
                }
                
                if (savedSubconDumpPlates) {
                    customSubconDumpPlates = JSON.parse(savedSubconDumpPlates);
                    console.log('‚úÖ Loaded', customSubconDumpPlates.length, 'custom Subcon Dump plates');
                }
                
                // Update combined arrays
                updatePlateArrays();
                
            } catch (error) {
                console.error('‚ùå Error loading custom plates:', error);
                customDenjoPlates = [];
                customDenjoDumpPlates = [];
                customSubconPlates = [];
                customSubconDumpPlates = [];
                updatePlateArrays();
            }
        }

        // Update combined plate arrays
        function updatePlateArrays() {
            denjoPlates = [...baseDenjoPlates, ...customDenjoPlates].sort();
            denjoDumpPlates = [...customDenjoDumpPlates].sort(); // Only custom plates for now
            subconPlates = [...baseSubconPlates, ...customSubconPlates].sort();
            subconDumpPlates = [...customSubconDumpPlates].sort(); // Only custom plates for now
            console.log('üìã Updated plate arrays - Denjo:', denjoPlates.length, 'Denjo Dump:', denjoDumpPlates.length, 'Subcon:', subconPlates.length, 'Subcon Dump:', subconDumpPlates.length);
        }

        // Save custom plates to localStorage
        function saveCustomPlates() {
            try {
                localStorage.setItem('customDenjoPlates', JSON.stringify(customDenjoPlates));
                localStorage.setItem('customDenjoDumpPlates', JSON.stringify(customDenjoDumpPlates));
                localStorage.setItem('customSubconPlates', JSON.stringify(customSubconPlates));
                localStorage.setItem('customSubconDumpPlates', JSON.stringify(customSubconDumpPlates));
                console.log('‚úÖ Custom plates saved successfully');
            } catch (error) {
                console.error('‚ùå Error saving custom plates:', error);
                showErrorMessage('Failed to save custom plates');
            }
        }

        // Add custom plate function
        function addCustomPlate() {
            const plateInput = document.getElementById('customPlateInput');
            const typeSelect = document.getElementById('customPlateType');
            
            const plateNumber = plateInput.value.trim().toUpperCase();
            const plateType = typeSelect.value;
            
            // Validation
            if (!plateNumber) {
                showErrorMessage('Please enter a plate number');
                return;
            }
            
            if (!plateType) {
                showErrorMessage('Please select truck type');
                return;
            }
            
            // Check if plate already exists in any list
            if (denjoPlates.includes(plateNumber) || denjoDumpPlates.includes(plateNumber) || 
                subconPlates.includes(plateNumber) || subconDumpPlates.includes(plateNumber)) {
                showErrorMessage(`Plate "${plateNumber}" already exists in the system`);
                return;
            }
            
            // Add to appropriate custom array
            if (plateType === 'denjo') {
                customDenjoPlates.push(plateNumber);
                showSuccessMessage(`Added "${plateNumber}" to Denjo trucks! üöõ`);
            } else if (plateType === 'denjo_dump') {
                customDenjoDumpPlates.push(plateNumber);
                showSuccessMessage(`Added "${plateNumber}" to Denjo Dump trucks! üöõ`);
            } else if (plateType === 'subcon') {
                customSubconPlates.push(plateNumber);
                showSuccessMessage(`Added "${plateNumber}" to Subcon trucks! üöö`);
            } else if (plateType === 'subcon_dump') {
                customSubconDumpPlates.push(plateNumber);
                showSuccessMessage(`Added "${plateNumber}" to Subcon Dump trucks! üöö`);
            }
            
            // Update arrays and save
            updatePlateArrays();
            saveCustomPlates();
            
            // Clear inputs
            plateInput.value = '';
            typeSelect.value = '';
            
            // Update UI if needed
            if (selectedTruckType) {
                renderPlateButtons();
            }
            if (multiSelectedTruckType) {
                renderMultiPlateButtons();
            }
        }

        // Handle Enter key for custom plate input
        function handleCustomPlateEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addCustomPlate();
            }
        }

        // Enhanced data loading with error handling
        function loadData() {
            try {
                const savedRecords = localStorage.getItem('dispatchRecords');
                if (savedRecords && savedRecords !== 'null' && savedRecords !== 'undefined') {
                    const parsedRecords = JSON.parse(savedRecords);
                    if (Array.isArray(parsedRecords)) {
                        dispatchRecords = parsedRecords;
                        console.log('‚úÖ Loaded', dispatchRecords.length, 'records from localStorage');
                        updateSiteTotals();
                        renderDispatchRecords();
                        renderSiteTotals();
                    } else {
                        console.log('‚ö†Ô∏è Invalid data format in localStorage, starting fresh');
                        dispatchRecords = [];
                    }
                } else {
                    console.log('üìù No saved data found, starting fresh');
                    dispatchRecords = [];
                }
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                dispatchRecords = [];
                // Try to backup corrupted data
                const corruptedData = localStorage.getItem('dispatchRecords');
                if (corruptedData) {
                    localStorage.setItem('dispatchRecords_backup_' + Date.now(), corruptedData);
                }
            }
        }

        // Enhanced save with multiple backups and error handling
        function saveData() {
            try {
                // Create backup before saving
                const currentData = localStorage.getItem('dispatchRecords');
                if (currentData && currentData !== 'null') {
                    localStorage.setItem('dispatchRecords_backup', currentData);
                }
                
                // Save main data
                const dataToSave = JSON.stringify(dispatchRecords);
                localStorage.setItem('dispatchRecords', dataToSave);
                
                // Verify save was successful
                const savedData = localStorage.getItem('dispatchRecords');
                if (savedData === dataToSave) {
                    console.log('‚úÖ Data saved successfully:', dispatchRecords.length, 'records');
                } else {
                    throw new Error('Data verification failed after save');
                }
            } catch (error) {
                console.error('‚ùå Error saving data:', error);
                // Try to restore from backup
                const backupData = localStorage.getItem('dispatchRecords_backup');
                if (backupData) {
                    try {
                        dispatchRecords = JSON.parse(backupData);
                        console.log('üîÑ Restored from backup');
                    } catch (backupError) {
                        console.error('‚ùå Backup restore failed:', backupError);
                    }
                }
                
                // Show error to user
                showErrorMessage('Failed to save data. Please try again.');
            }
        }

        // Auto-save every 30 seconds as additional protection
        setInterval(() => {
            if (dispatchRecords.length > 0) {
                saveData();
            }
        }, 30000);

        // Set today's date as default
        dispatchDateInput.valueAsDate = new Date();

        // Event listeners
        addDispatchBtn.addEventListener('click', addDispatchRecord);
        addMultiDispatchBtn.addEventListener('click', addMultiDispatchRecord);
        
        // Add date change listener to update button state
        dispatchDateInput.addEventListener('change', function() {
            console.log('Date changed to:', this.value);
            updateRate();
        });

        // Load saved data when page loads
        loadCustomPlates(); // Load custom plates first
        loadData();

        // Save data when page is about to be closed/refreshed
        window.addEventListener('beforeunload', function(e) {
            if (dispatchRecords.length > 0) {
                saveData();
                console.log('üíæ Data saved before page unload');
            }
        });

        // Save data when page becomes hidden (mobile/tab switching)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && dispatchRecords.length > 0) {
                saveData();
                console.log('üíæ Data saved on visibility change');
            }
        });

        // Save data when window loses focus
        window.addEventListener('blur', function() {
            if (dispatchRecords.length > 0) {
                saveData();
                console.log('üíæ Data saved on window blur');
            }
        });

        function selectTruckType(type) {
            selectedTruckType = type;
            // Only reset selectedPlates if manually selecting truck type (not from auto-detection)
            const isAutoDetection = arguments[1]; // Second parameter to indicate auto-detection
            if (!isAutoDetection && !document.getElementById('plateSearch').value) {
                selectedPlates = {};
                updateSelectedPlatesDisplay();
            }
            
            // Only reset location/site if manually selecting truck type
            if (!isAutoDetection) {
                selectedLocation = '';
                selectedSite = '';
            }
            
            // Update button styles
            document.getElementById('denjoBtn').className = type === 'denjo' ? 
                'p-4 border-2 border-blue-500 bg-blue-50 rounded-lg text-center font-semibold text-blue-700' :
                'p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors text-center font-semibold';
            
            document.getElementById('denjoDumpBtn').className = type === 'denjo_dump' ? 
                'p-4 border-2 border-blue-500 bg-blue-50 rounded-lg text-center font-semibold text-blue-700' :
                'p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors text-center font-semibold';
            
            document.getElementById('subconBtn').className = type === 'subcon' ? 
                'p-4 border-2 border-green-500 bg-green-50 rounded-lg text-center font-semibold text-green-700' :
                'p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors text-center font-semibold';
            
            document.getElementById('subconDumpBtn').className = type === 'subcon_dump' ? 
                'p-4 border-2 border-green-500 bg-green-50 rounded-lg text-center font-semibold text-green-700' :
                'p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors text-center font-semibold';
            
            // Show location section and populate ALL locations
            const locationSection = document.getElementById('locationSection');
            const locationButtons = document.getElementById('locationButtons');
            locationSection.classList.remove('hidden');
            
            // Get rates based on truck type
            let rates;
            if (type === 'denjo') rates = denjoRates;
            else if (type === 'denjo_dump') rates = denjoDumpRates;
            else if (type === 'subcon') rates = subconRates;
            else if (type === 'subcon_dump') rates = subconDumpRates;
            else rates = {};
            
            // Combine ALL locations from all rate types
            const allLocations = new Set([...Object.keys(denjoRates), ...Object.keys(denjoDumpRates), ...Object.keys(subconRates), ...Object.keys(subconDumpRates)]);
            const sortedLocations = Array.from(allLocations).sort();
            
            locationButtons.innerHTML = sortedLocations.map(location => {
                // Check if this location has rates for the selected truck type
                const hasRate = rates[location] !== undefined;
                const buttonClass = hasRate ? 
                    'p-3 border border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-sm font-medium' :
                    'p-3 border border-red-300 bg-red-50 rounded-lg text-sm font-medium text-red-600 cursor-not-allowed opacity-60';
                const buttonText = hasRate ? location : `${location} (No rate for ${type.toUpperCase().replace('_', ' ')})`;
                const onClickAction = hasRate ? `onclick="selectLocation('${location}')"` : '';
                
                return `<button class="${buttonClass}" ${onClickAction}>${buttonText}</button>`;
            }).join('');
            
            // Hide site section initially only if manually selecting
            if (!isAutoDetection) {
                document.getElementById('siteSection').classList.add('hidden');
            }
            
            updateRate();
        }

        function renderPlateButtons(filteredPlates = null) {
            const plateButtons = document.getElementById('plateButtons');
            let plates;
            
            if (filteredPlates) {
                plates = filteredPlates;
            } else {
                if (selectedTruckType === 'denjo') plates = denjoPlates;
                else if (selectedTruckType === 'denjo_dump') plates = denjoDumpPlates;
                else if (selectedTruckType === 'subcon') plates = subconPlates;
                else if (selectedTruckType === 'subcon_dump') plates = subconDumpPlates;
                else plates = [];
            }
            
            if (plates.length === 0) {
                plateButtons.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">No plates found matching your search</div>';
                return;
            }
            
            plateButtons.innerHTML = plates.map(plate => 
                `<button class="${selectedPlates[plate] ? 'p-2 border-2 border-green-500 bg-green-50 rounded-lg text-sm font-medium text-green-700' : 'p-2 border border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-sm font-medium'}" onclick="togglePlateSelection('${plate}')">${plate}${selectedPlates[plate] ? ` (${selectedPlates[plate]})` : ''}</button>`
            ).join('');
        }

        function renderMixedPlateButtons(denjoMatches, denjoDumpMatches, subconMatches, subconDumpMatches) {
            const plateButtons = document.getElementById('plateButtons');
            
            // Combine and sort all matches
            const allMatches = [...denjoMatches, ...denjoDumpMatches, ...subconMatches, ...subconDumpMatches].sort();
            
            plateButtons.innerHTML = allMatches.map(plate => {
                let truckType, truckTypeColor, truckTypeLabel;
                
                if (denjoMatches.includes(plate)) {
                    truckType = 'denjo';
                    truckTypeColor = 'blue';
                    truckTypeLabel = 'D';
                } else if (denjoDumpMatches.includes(plate)) {
                    truckType = 'denjo_dump';
                    truckTypeColor = 'blue';
                    truckTypeLabel = 'DD';
                } else if (subconMatches.includes(plate)) {
                    truckType = 'subcon';
                    truckTypeColor = 'green';
                    truckTypeLabel = 'S';
                } else if (subconDumpMatches.includes(plate)) {
                    truckType = 'subcon_dump';
                    truckTypeColor = 'green';
                    truckTypeLabel = 'SD';
                }
                
                const isSelected = selectedPlates[plate];
                
                return `<button class="${isSelected ? 'p-2 border-2 border-green-500 bg-green-50 rounded-lg text-sm font-medium text-green-700' : `p-2 border border-gray-300 rounded-lg hover:border-${truckTypeColor}-500 hover:bg-${truckTypeColor}-50 transition-colors text-sm font-medium`}" onclick="selectPlateWithType('${plate}', '${truckType}')">
                    <div class="flex items-center justify-between">
                        <span>${plate}${selectedPlates[plate] ? ` (${selectedPlates[plate]})` : ''}</span>
                        <span class="ml-1 px-1 py-0.5 text-xs rounded ${truckTypeColor === 'blue' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}">${truckTypeLabel}</span>
                    </div>
                </button>`;
            }).join('');
        }

        function filterPlates() {
            const searchTerm = document.getElementById('plateSearch').value.toUpperCase().trim();
            
            console.log('Search term:', searchTerm);
            
            if (searchTerm.length === 0) {
                // Reset everything if search is empty
                if (selectedTruckType) {
                    renderPlateButtons();
                } else {
                    // Show initial message when no truck type selected and no search
                    document.getElementById('plateButtons').innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">Start typing to see matching plate numbers</div>';
                }
                return;
            }
            
            // Enhanced search - multiple search methods for better accuracy
            const searchFilter = (plate) => {
                const plateUpper = plate.toUpperCase().trim();
                const plateNoSpaces = plateUpper.replace(/\s+/g, '');
                const searchNoSpaces = searchTerm.replace(/\s+/g, '');
                
                return (
                    plateUpper.includes(searchTerm) ||                    // Contains search term exactly
                    plateUpper.startsWith(searchTerm) ||                 // Starts with search term
                    plateNoSpaces.includes(searchNoSpaces) ||            // Remove spaces and search
                    plateUpper.split(' ').some(part => part.includes(searchTerm)) || // Any part contains search term
                    plateUpper.split(' ').some(part => part.startsWith(searchTerm)) || // Any part starts with search term
                    plateUpper.endsWith(searchTerm) ||                   // Ends with search term
                    plateNoSpaces.endsWith(searchNoSpaces)               // Ends with search term (no spaces)
                );
            };
            
            const denjoMatches = denjoPlates.filter(searchFilter);
            const denjoDumpMatches = denjoDumpPlates.filter(searchFilter);
            const subconMatches = subconPlates.filter(searchFilter);
            const subconDumpMatches = subconDumpPlates.filter(searchFilter);
            
            console.log('Denjo matches:', denjoMatches);
            console.log('Denjo Dump matches:', denjoDumpMatches);
            console.log('Subcon matches:', subconMatches);
            console.log('Subcon Dump matches:', subconDumpMatches);
            
            // Combine all matches and show them
            const allMatches = [...denjoMatches, ...denjoDumpMatches, ...subconMatches, ...subconDumpMatches].sort();
            
            if (allMatches.length === 0) {
                // No matches found - show helpful message
                document.getElementById('plateButtons').innerHTML = `
                    <div class="col-span-full text-center text-gray-500 py-4">
                        <div>No plates found matching "${searchTerm}"</div>
                        <div class="text-xs mt-2">üí° Try searching with just letters (e.g., "WMZ") or numbers (e.g., "181")</div>
                    </div>`;
                return;
            }
            
            // Count matches by type
            const matchCounts = [
                denjoMatches.length > 0 ? 1 : 0,
                denjoDumpMatches.length > 0 ? 1 : 0,
                subconMatches.length > 0 ? 1 : 0,
                subconDumpMatches.length > 0 ? 1 : 0
            ].reduce((a, b) => a + b, 0);
            
            // Auto-detect and set truck type if only one type has matches
            if (matchCounts === 1) {
                if (denjoMatches.length > 0) {
                    if (selectedTruckType !== 'denjo') {
                        selectTruckType('denjo', true); // true indicates auto-detection
                    }
                    renderPlateButtons(denjoMatches);
                } else if (denjoDumpMatches.length > 0) {
                    if (selectedTruckType !== 'denjo_dump') {
                        selectTruckType('denjo_dump', true);
                    }
                    renderPlateButtons(denjoDumpMatches);
                } else if (subconMatches.length > 0) {
                    if (selectedTruckType !== 'subcon') {
                        selectTruckType('subcon', true);
                    }
                    renderPlateButtons(subconMatches);
                } else if (subconDumpMatches.length > 0) {
                    if (selectedTruckType !== 'subcon_dump') {
                        selectTruckType('subcon_dump', true);
                    }
                    renderPlateButtons(subconDumpMatches);
                }
            } else {
                // Multiple types have matches - show all with type indicators
                renderMixedPlateButtons(denjoMatches, denjoDumpMatches, subconMatches, subconDumpMatches);
            }
        }

        function togglePlateSelection(plate) {
            if (selectedPlates[plate]) {
                // Remove plate from selection
                delete selectedPlates[plate];
            } else {
                // Add plate to selection with quantity 1
                selectedPlates[plate] = 1;
                
                // Clear search input after selecting a plate
                document.getElementById('plateSearch').value = '';
                
                // Reset plate buttons to show all available plates for current truck type
                if (selectedTruckType) {
                    renderPlateButtons();
                }
            }
            
            // Update displays
            updateSelectedPlatesDisplay();
            updateRate();
        }

        function selectPlateWithType(plate, truckType) {
            // Auto-select truck type if not already selected or if different
            if (selectedTruckType !== truckType) {
                selectTruckType(truckType, true); // true indicates auto-detection
                // Wait for selectTruckType to complete before continuing
                setTimeout(() => {
                    // Add plate to selection
                    if (!selectedPlates[plate]) {
                        selectedPlates[plate] = 1;
                    }
                    
                    // Clear search input after selecting a plate
                    document.getElementById('plateSearch').value = '';
                    
                    // Reset plate buttons to show all available plates for current truck type
                    renderPlateButtons();
                    
                    // Update displays
                    updateSelectedPlatesDisplay();
                    updateRate();
                }, 100);
            } else {
                // Add plate to selection
                if (!selectedPlates[plate]) {
                    selectedPlates[plate] = 1;
                }
                
                // Clear search input after selecting a plate
                document.getElementById('plateSearch').value = '';
                
                // Reset plate buttons to show all available plates for current truck type
                renderPlateButtons();
                
                // Update displays
                updateSelectedPlatesDisplay();
                updateRate();
            }
        }

        function updateSelectedPlatesDisplay() {
            const display = document.getElementById('selectedPlatesDisplay');
            const list = document.getElementById('selectedPlatesList');
            
            if (Object.keys(selectedPlates).length === 0) {
                display.classList.add('hidden');
                return;
            }
            
            display.classList.remove('hidden');
            list.innerHTML = Object.entries(selectedPlates).map(([plate, quantity]) => 
                `<div class="flex items-center justify-between p-3 bg-white rounded-lg border border-green-200">
                    <div class="flex items-center gap-3">
                        <span class="font-medium text-gray-800">${plate}</span>
                        <span class="text-xs text-gray-500">visits this site</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="adjustPlateQuantity('${plate}', -1)" class="w-8 h-8 bg-red-100 hover:bg-red-200 text-red-600 rounded-full flex items-center justify-center font-bold">-</button>
                        <span class="w-8 text-center font-bold text-lg">${quantity}</span>
                        <button onclick="adjustPlateQuantity('${plate}', 1)" class="w-8 h-8 bg-green-100 hover:bg-green-200 text-green-600 rounded-full flex items-center justify-center font-bold">+</button>
                        <button onclick="removePlateFromSelection('${plate}')" class="ml-2 text-red-500 hover:text-red-700 font-bold">√ó</button>
                    </div>
                </div>`
            ).join('');
        }

        function adjustPlateQuantity(plate, change) {
            if (selectedPlates[plate]) {
                selectedPlates[plate] += change;
                if (selectedPlates[plate] <= 0) {
                    delete selectedPlates[plate];
                }
                updateSelectedPlatesDisplay();
                renderPlateButtons();
                updateRate();
            }
        }

        function removePlateFromSelection(plate) {
            delete selectedPlates[plate];
            updateSelectedPlatesDisplay();
            renderPlateButtons();
            updateRate();
        }

        function clearAllSelectedPlates() {
            selectedPlates = {};
            updateSelectedPlatesDisplay();
            renderPlateButtons();
            updateRate();
        }

        function selectLocation(location) {
            selectedLocation = location;
            selectedSite = '';
            
            // Update location button styles
            const rates = selectedTruckType === 'denjo' ? denjoRates : subconRates;
            const locationButtons = document.getElementById('locationButtons');
            locationButtons.innerHTML = Object.keys(rates).map(loc => 
                `<button class="${loc === location ? 'p-3 border-2 border-blue-500 bg-blue-50 rounded-lg text-sm font-medium text-blue-700' : 'p-3 border border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-sm font-medium'}" onclick="selectLocation('${loc}')">${loc}</button>`
            ).join('');
            
            // Show and populate site section
            const siteSection = document.getElementById('siteSection');
            const siteButtons = document.getElementById('siteButtons');
            siteSection.classList.remove('hidden');
            
            if (locationSites[location]) {
                siteButtons.innerHTML = locationSites[location].map(site => 
                    `<button class="p-2 border border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-sm font-medium" onclick="selectSite('${site}')">${site}</button>`
                ).join('');
            }
            
            updateRate();
        }

        function selectSite(site) {
            selectedSite = site;
            
            // Update site button styles
            const siteButtons = document.getElementById('siteButtons');
            siteButtons.innerHTML = locationSites[selectedLocation].map(s => 
                `<button class="${s === site ? 'p-2 border-2 border-blue-500 bg-blue-50 rounded-lg text-sm font-medium text-blue-700' : 'p-2 border border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors text-sm font-medium'}" onclick="selectSite('${s}')">${s}</button>`
            ).join('');
            
            updateRate();
        }

        function updateRate() {
            // Always check all required fields first
            const hasPlates = Object.keys(selectedPlates).length > 0;
            const hasLocation = selectedLocation && selectedLocation.trim() !== '';
            const hasSite = selectedSite && selectedSite.trim() !== '';
            const hasDate = dispatchDateInput.value && dispatchDateInput.value.trim() !== '';
            
            console.log('UpdateRate Debug - Field Check:', {
                hasPlates: hasPlates,
                platesCount: Object.keys(selectedPlates).length,
                selectedPlates: selectedPlates,
                hasLocation: hasLocation,
                selectedLocation: selectedLocation,
                hasSite: hasSite,
                selectedSite: selectedSite,
                hasDate: hasDate,
                dateValue: dispatchDateInput.value,
                selectedTruckType: selectedTruckType
            });

            if (!hasPlates) {
                currentRateDiv.textContent = '‚Ç±0.00';
                addDispatchBtn.disabled = true;
                addDispatchBtn.textContent = 'Select plates first';
                console.log('UpdateRate: Disabled - No plates selected');
                return;
            }

            if (!hasLocation) {
                currentRateDiv.textContent = '‚Ç±0.00';
                addDispatchBtn.disabled = true;
                addDispatchBtn.textContent = 'Select location first';
                console.log('UpdateRate: Disabled - No location selected');
                return;
            }

            if (!hasSite) {
                currentRateDiv.textContent = '‚Ç±0.00';
                addDispatchBtn.disabled = true;
                addDispatchBtn.textContent = 'Select site first';
                console.log('UpdateRate: Disabled - No site selected');
                return;
            }

            if (!hasDate) {
                currentRateDiv.textContent = '‚Ç±0.00';
                addDispatchBtn.disabled = true;
                addDispatchBtn.textContent = 'Select date first';
                console.log('UpdateRate: Disabled - No date selected');
                return;
            }

            // Calculate total rate based on each plate's actual truck type and quantity
            let totalRate = 0;
            let rateBreakdown = [];
            let hasInvalidRates = false;
            let invalidPlates = [];
            
            Object.entries(selectedPlates).forEach(([plate, quantity]) => {
                let truckType, rates;
                if (denjoPlates.includes(plate)) {
                    truckType = 'denjo';
                    rates = denjoRates;
                } else if (denjoDumpPlates.includes(plate)) {
                    truckType = 'denjo_dump';
                    rates = denjoDumpRates;
                } else if (subconPlates.includes(plate)) {
                    truckType = 'subcon';
                    rates = subconRates;
                } else if (subconDumpPlates.includes(plate)) {
                    truckType = 'subcon_dump';
                    rates = subconDumpRates;
                } else {
                    // Default fallback - shouldn't happen but just in case
                    truckType = 'unknown';
                    rates = {};
                }
                const rate = rates[selectedLocation];
                
                if (!rate || rate <= 0) {
                    hasInvalidRates = true;
                    invalidPlates.push(`${plate} (${truckType.toUpperCase()})`);
                    return; // Skip this plate in calculation
                }
                
                const plateTotal = rate * quantity;
                totalRate += plateTotal;
                
                // Group by rate for display
                const existingRate = rateBreakdown.find(r => r.rate === rate && r.type === truckType);
                if (existingRate) {
                    existingRate.count += quantity;
                } else {
                    rateBreakdown.push({ rate, count: quantity, type: truckType });
                }
            });
            
            // Create breakdown text
            if (hasInvalidRates) {
                const validBreakdown = rateBreakdown.length > 0 ? 
                    rateBreakdown.map(r => 
                        `${r.count} ${r.type.toUpperCase()} √ó ‚Ç±${r.rate.toLocaleString('en-PH', {minimumFractionDigits: 2})}`
                    ).join(' + ') : '';
                
                const invalidText = `‚ö†Ô∏è No rates: ${invalidPlates.join(', ')}`;
                currentRateDiv.innerHTML = `
                    <div>‚Ç±${totalRate.toLocaleString('en-PH', {minimumFractionDigits: 2})} ${validBreakdown ? `(${validBreakdown})` : ''}</div>
                    <div class="text-xs text-red-600 mt-1">${invalidText}</div>
                `;
            } else {
                const breakdownText = rateBreakdown.map(r => 
                    `${r.count} ${r.type.toUpperCase()} √ó ‚Ç±${r.rate.toLocaleString('en-PH', {minimumFractionDigits: 2})}`
                ).join(' + ');
                
                currentRateDiv.textContent = `‚Ç±${totalRate.toLocaleString('en-PH', {minimumFractionDigits: 2})} (${breakdownText})`;
            }
            
            // Enable add button ONLY if ALL fields are properly filled AND no invalid rates
            const allFieldsFilled = hasPlates && hasLocation && hasSite && hasDate && !hasInvalidRates;
            addDispatchBtn.disabled = !allFieldsFilled;
            
            if (hasInvalidRates) {
                addDispatchBtn.textContent = `Cannot add - No rates for selected location`;
            } else if (allFieldsFilled) {
                addDispatchBtn.textContent = 'Add Dispatch Entry';
            }
            
            console.log('UpdateRate Final:', {
                allFieldsFilled: allFieldsFilled,
                buttonDisabled: addDispatchBtn.disabled,
                totalRate: totalRate,
                breakdown: rateBreakdown
            });
        }

        function addDispatchRecord() {
            // Prevent double-clicking
            if (addDispatchBtn.disabled) {
                console.log('‚ùå Button is disabled, preventing duplicate submission');
                return;
            }
            
            // Temporarily disable button to prevent double-clicks
            addDispatchBtn.disabled = true;
            addDispatchBtn.textContent = 'Adding...';
            
            try {
                // Double-check all fields before proceeding
                const hasPlates = Object.keys(selectedPlates).length > 0;
                const hasLocation = selectedLocation && selectedLocation.trim() !== '';
                const hasSite = selectedSite && selectedSite.trim() !== '';
                const hasDate = dispatchDateInput.value && dispatchDateInput.value.trim() !== '';
                
                console.log('Add Dispatch Debug - Final Check:', {
                    hasPlates: hasPlates,
                    selectedPlates: selectedPlates,
                    hasLocation: hasLocation,
                    selectedLocation: selectedLocation,
                    hasSite: hasSite,
                    selectedSite: selectedSite,
                    hasDate: hasDate,
                    dateValue: dispatchDateInput.value
                });
                
                if (!hasPlates || !hasLocation || !hasSite || !hasDate) {
                    const missingFields = [];
                    if (!hasPlates) missingFields.push('Plates');
                    if (!hasLocation) missingFields.push('Location');
                    if (!hasSite) missingFields.push('Site');
                    if (!hasDate) missingFields.push('Date');
                    
                    showErrorMessage(`Missing required fields: ${missingFields.join(', ')}`);
                    updateRate(); // This will re-enable the button with proper text
                    return;
                }
                
                let totalRecordsAdded = 0;
                const recordsToAdd = [];
                
                // Create records for each selected plate based on quantity
                Object.entries(selectedPlates).forEach(([plate, quantity]) => {
                    // Auto-detect truck type based on plate registration
                    let truckType, rates;
                    if (denjoPlates.includes(plate)) {
                        truckType = 'denjo';
                        rates = denjoRates;
                    } else if (denjoDumpPlates.includes(plate)) {
                        truckType = 'denjo_dump';
                        rates = denjoDumpRates;
                    } else if (subconPlates.includes(plate)) {
                        truckType = 'subcon';
                        rates = subconRates;
                    } else if (subconDumpPlates.includes(plate)) {
                        truckType = 'subcon_dump';
                        rates = subconDumpRates;
                    } else {
                        throw new Error(`Plate "${plate}" not found in any truck type list`);
                    }
                    const rate = rates[selectedLocation];
                    
                    // Enhanced rate validation with better error messages
                    if (!rate || rate <= 0) {
                        const availableLocations = Object.keys(rates).join(', ');
                        throw new Error(`No rate available for ${truckType.toUpperCase()} truck "${plate}" at location "${selectedLocation}". Available locations for ${truckType.toUpperCase()}: ${availableLocations}`);
                    }
                    
                    // Create multiple records based on quantity
                    for (let i = 0; i < quantity; i++) {
                        const record = {
                            id: Date.now() + Math.random() + i + totalRecordsAdded, // Ensure unique IDs
                            truckType: truckType, // Auto-detected based on plate
                            plateNumber: plate,
                            location: selectedLocation,
                            site: selectedSite,
                            date: dispatchDateInput.value,
                            rate: rate
                        };
                        recordsToAdd.push(record);
                        totalRecordsAdded++;
                    }
                });

                // Add all records at once
                dispatchRecords.push(...recordsToAdd);
                console.log('‚úÖ Added', totalRecordsAdded, 'records successfully');

                // Save and update displays
                saveData();
                updateSiteTotals();
                renderDispatchRecords();
                renderSiteTotals();
                
                // Reset form
                resetForm();
                
                // Show success message
                showSuccessMessage(totalRecordsAdded);
                
            } catch (error) {
                console.error('‚ùå Error adding dispatch record:', error);
                showErrorMessage('Failed to add dispatch record: ' + error.message);
                updateRate(); // Re-enable button
            }
        }

        function resetForm() {
            selectedTruckType = '';
            selectedPlates = {};
            selectedLocation = '';
            selectedSite = '';
            
            // Reset truck type buttons
            document.getElementById('denjoBtn').className = 'p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors text-center font-semibold';
            document.getElementById('denjoDumpBtn').className = 'p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors text-center font-semibold';
            document.getElementById('subconBtn').className = 'p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors text-center font-semibold';
            document.getElementById('subconDumpBtn').className = 'p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors text-center font-semibold';
            
            // Clear search input
            document.getElementById('plateSearch').value = '';
            
            // Hide sections
            document.getElementById('locationSection').classList.add('hidden');
            document.getElementById('siteSection').classList.add('hidden');
            
            // Reset plate buttons to initial state
            document.getElementById('plateButtons').innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">Start typing to see matching plate numbers</div>';
            
            // Hide selected plates display
            updateSelectedPlatesDisplay();
            
            // Reset rate and button
            currentRateDiv.textContent = '‚Ç±0.00';
            addDispatchBtn.disabled = true;
        }

        function updateSiteTotals() {
            siteTotals = {};
            
            dispatchRecords.forEach(record => {
                const siteKey = `${record.location} - ${record.site}`;
                if (!siteTotals[siteKey]) {
                    siteTotals[siteKey] = {
                        location: record.location,
                        site: record.site,
                        total: 0,
                        count: 0,
                        denjoTotal: 0,
                        subconTotal: 0,
                        denjoCount: 0,
                        subconCount: 0
                    };
                }
                
                siteTotals[siteKey].total += record.rate;
                siteTotals[siteKey].count += 1;
                
                if (record.truckType === 'denjo') {
                    siteTotals[siteKey].denjoTotal += record.rate;
                    siteTotals[siteKey].denjoCount += 1;
                } else {
                    siteTotals[siteKey].subconTotal += record.rate;
                    siteTotals[siteKey].subconCount += 1;
                }
            });
        }

        function renderSiteTotals() {
            if (Object.keys(siteTotals).length === 0) {
                siteTotalsDiv.innerHTML = '<div class="text-gray-500 text-center py-8 col-span-full">No sites added yet. Add dispatch entries to see totals!</div>';
                return;
            }

            siteTotalsDiv.innerHTML = Object.entries(siteTotals).map(([siteKey, data]) => `
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-6 border border-blue-200 cursor-pointer hover:shadow-lg transition-shadow" onclick="showSiteDetails('${siteKey}')">
                    <div class="text-sm font-semibold text-gray-600 mb-1">${data.location}</div>
                    <div class="text-lg font-bold text-gray-800 mb-4">${data.site}</div>
                    <div class="text-xs text-blue-600 mb-4">üëÜ Click to see plate details</div>
                    <div class="space-y-3">
                        ${data.denjoCount > 0 ? `
                        <div class="bg-blue-100 rounded-lg p-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-bold text-blue-700">DENJO TOTAL:</span>
                                <span class="text-lg font-bold text-blue-700">‚Ç±${data.denjoTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                            </div>
                            <div class="text-xs text-blue-600">${data.denjoCount} trips</div>
                        </div>
                        ` : ''}
                        ${data.subconCount > 0 ? `
                        <div class="bg-green-100 rounded-lg p-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-sm font-bold text-green-700">SUBCON TOTAL:</span>
                                <span class="text-lg font-bold text-green-700">‚Ç±${data.subconTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                            </div>
                            <div class="text-xs text-green-600">${data.subconCount} trips</div>
                        </div>
                        ` : ''}
                        <div class="border-t border-gray-300 pt-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-bold text-gray-700">GRAND TOTAL:</span>
                                <span class="text-xl font-bold text-purple-600">‚Ç±${data.total.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                            </div>
                            <div class="text-xs text-gray-600">${data.count} total trips</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderDispatchRecords() {
            if (dispatchRecords.length === 0) {
                dispatchRecordsDiv.innerHTML = '<div class="text-gray-500 text-center py-8">No dispatch records yet. Add your first entry above!</div>';
                return;
            }

            dispatchRecordsDiv.innerHTML = dispatchRecords.map(record => `
                <div class="bg-gray-50 rounded-lg p-4 border-l-4 ${record.truckType === 'denjo' ? 'border-blue-500' : 'border-green-500'}">
                    <div class="flex justify-between items-start">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 flex-1">
                            <div>
                                <div class="text-xs font-semibold text-gray-500 uppercase">Truck Type</div>
                                <div class="font-semibold ${record.truckType === 'denjo' ? 'text-blue-600' : 'text-green-600'}">${record.truckType.toUpperCase()}</div>
                            </div>
                            <div>
                                <div class="text-xs font-semibold text-gray-500 uppercase">Plate Number</div>
                                <div class="font-semibold">${record.plateNumber}</div>
                            </div>
                            <div>
                                <div class="text-xs font-semibold text-gray-500 uppercase">Location</div>
                                <div class="font-semibold">${record.location}</div>
                            </div>
                            <div>
                                <div class="text-xs font-semibold text-gray-500 uppercase">Site</div>
                                <div class="font-semibold">${record.site}</div>
                            </div>
                            <div>
                                <div class="text-xs font-semibold text-gray-500 uppercase">Date</div>
                                <div class="font-semibold">${new Date(record.date).toLocaleDateString('en-PH')}</div>
                            </div>
                            <div>
                                <div class="text-xs font-semibold text-gray-500 uppercase">Rate</div>
                                <div class="font-bold text-lg text-green-600">‚Ç±${record.rate.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                            </div>
                        </div>
                        <div class="ml-4 flex gap-2">
                            <button onclick="editRecord(${record.id})" class="text-blue-500 hover:text-blue-700 font-semibold">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="removeRecord(${record.id})" class="text-red-500 hover:text-red-700 font-semibold">
                                ‚úï
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function editRecord(id) {
            const record = dispatchRecords.find(r => r.id === id);
            if (!record) return;
            
            // Fill form with existing data
            selectTruckType(record.truckType);
            
            // Wait a bit for the UI to update, then select other fields
            setTimeout(() => {
                selectedPlates = [record.plateNumber];
                updateSelectedPlatesDisplay();
                selectLocation(record.location);
                
                setTimeout(() => {
                    selectSite(record.site);
                    dispatchDateInput.value = record.date;
                    
                    // Remove the original record
                    dispatchRecords = dispatchRecords.filter(r => r.id !== id);
                    saveData();
                    updateSiteTotals();
                    renderDispatchRecords();
                    renderSiteTotals();
                    
                    // Show edit message
                    showEditMessage();
                    
                    // Scroll to top
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 100);
            }, 100);
        }

        function removeRecord(id) {
            dispatchRecords = dispatchRecords.filter(record => record.id !== id);
            saveData(); // Save to localStorage
            updateSiteTotals();
            renderDispatchRecords();
            renderSiteTotals();
        }

        function showSuccessMessage(totalRecords) {
            const message = document.createElement('div');
            message.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            message.textContent = `‚úì ${totalRecords} dispatch record${totalRecords > 1 ? 's' : ''} added successfully!`;
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 3000);
        }

        function showEditMessage() {
            const message = document.createElement('div');
            message.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            message.textContent = '‚úèÔ∏è Record loaded for editing. Make changes and click Add to save.';
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 4000);
        }

        function showErrorMessage(text) {
            const message = document.createElement('div');
            message.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            message.textContent = '‚ùå ' + text;
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 5000);
        }

        function showSiteDetails(siteKey) {
            const data = siteTotals[siteKey];
            if (!data) return;
            
            // Get all records for this site
            const siteRecords = dispatchRecords.filter(record => 
                `${record.location} - ${record.site}` === siteKey
            );
            
            // Count plates and separate by truck type
            const plateCounts = {};
            siteRecords.forEach(record => {
                // Use the actual truck type from the record, not from plate detection
                const key = `${record.plateNumber}_${record.truckType}`;
                if (!plateCounts[key]) {
                    plateCounts[key] = {
                        plateNumber: record.plateNumber,
                        count: 0,
                        truckType: record.truckType, // This comes from the actual dispatch record
                        total: 0
                    };
                }
                plateCounts[key].count += 1;
                plateCounts[key].total += record.rate;
            });
            
            // Separate plates by truck type for better organization
            const denjoPlateEntries = Object.entries(plateCounts).filter(([key, info]) => info.truckType === 'denjo').sort(([a], [b]) => a.localeCompare(b));
            const subconPlateEntries = Object.entries(plateCounts).filter(([key, info]) => info.truckType === 'subcon').sort(([a], [b]) => a.localeCompare(b));
            
            // Create modal content with sections for each truck type
            let plateDetails = '';
            
            if (denjoPlateEntries.length > 0) {
                plateDetails += `
                    <div class="mb-6">
                        <h5 class="text-md font-bold text-blue-700 mb-3 flex items-center gap-2">
                            üöõ DENJO TRUCKS (${denjoPlateEntries.length} plates)
                        </h5>
                        <div class="space-y-2">
                            ${denjoPlateEntries.map(([key, info]) => `
                                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg border border-blue-200">
                                    <div class="flex items-center gap-3">
                                        <span class="font-bold text-lg text-blue-800">${info.plateNumber}</span>
                                        <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-700">DENJO</span>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold text-lg text-green-600">‚Ç±${info.total.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                                        <div class="text-sm text-gray-600">${info.count} trips</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (subconPlateEntries.length > 0) {
                plateDetails += `
                    <div class="mb-6">
                        <h5 class="text-md font-bold text-green-700 mb-3 flex items-center gap-2">
                            üöö SUBCON TRUCKS (${subconPlateEntries.length} plates)
                        </h5>
                        <div class="space-y-2">
                            ${subconPlateEntries.map(([key, info]) => `
                                <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-200">
                                    <div class="flex items-center gap-3">
                                        <span class="font-bold text-lg text-green-800">${info.plateNumber}</span>
                                        <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">SUBCON</span>
                                    </div>
                                    <div class="text-right">
                                        <div class="font-bold text-lg text-green-600">‚Ç±${info.total.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                                        <div class="text-sm text-gray-600">${info.count} trips</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Create and show modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">${data.location}</h3>
                                <p class="text-lg text-gray-600">${data.site}</p>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">√ó</button>
                        </div>
                    </div>
                    <div class="p-6">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">üìã Plate Numbers & Trip Counts</h4>
                        <div class="space-y-3 mb-6">
                            ${plateDetails}
                        </div>
                        <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-4 border border-purple-200">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-bold text-gray-700">SITE TOTAL:</span>
                                <span class="text-2xl font-bold text-purple-600">‚Ç±${data.total.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">${data.count} total trips ‚Ä¢ ${Object.values(plateCounts).length} plate entries</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                
                // If all fields are filled, add the dispatch record
                if (selectedPlates.length > 0 && selectedLocation && selectedSite && dispatchDateInput.value) {
                    addDispatchRecord();
                    return;
                }
                
                // Auto-select first matching plate if search has results
                const searchTerm = document.getElementById('plateSearch').value.toUpperCase();
                if (searchTerm && selectedPlates.length === 0) {
                    const denjoMatches = denjoPlates.filter(plate => 
                        plate.toUpperCase().includes(searchTerm)
                    );
                    const subconMatches = subconPlates.filter(plate => 
                        plate.toUpperCase().includes(searchTerm)
                    );
                    
                    let firstMatch = null;
                    if (denjoMatches.length > 0 && subconMatches.length === 0) {
                        firstMatch = denjoMatches[0];
                    } else if (subconMatches.length > 0 && denjoMatches.length === 0) {
                        firstMatch = subconMatches[0];
                    } else if (denjoMatches.length > 0 || subconMatches.length > 0) {
                        firstMatch = [...denjoMatches, ...subconMatches].sort()[0];
                    }
                    
                    if (firstMatch) {
                        togglePlateSelection(firstMatch);
                    }
                }
            }
        }

        // Multi-Site Functions
        function selectMultiTruckType(type) {
            multiSelectedTruckType = type;
            multiSelectedPlates = [];
            multiSelectedLocation = '';
            multiSelectedSites = [];
            
            // Update button styles
            document.getElementById('multiDenjoBtn').className = type === 'denjo' ? 
                'p-4 border-2 border-blue-500 bg-blue-50 rounded-lg text-center font-semibold text-blue-700' :
                'p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors text-center font-semibold';
            
            document.getElementById('multiDenjoDumpBtn').className = type === 'denjo_dump' ? 
                'p-4 border-2 border-blue-500 bg-blue-50 rounded-lg text-center font-semibold text-blue-700' :
                'p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors text-center font-semibold';
            
            document.getElementById('multiSubconBtn').className = type === 'subcon' ? 
                'p-4 border-2 border-green-500 bg-green-50 rounded-lg text-center font-semibold text-green-700' :
                'p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors text-center font-semibold';
            
            document.getElementById('multiSubconDumpBtn').className = type === 'subcon_dump' ? 
                'p-4 border-2 border-green-500 bg-green-50 rounded-lg text-center font-semibold text-green-700' :
                'p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors text-center font-semibold';
            
            // Show plate section
            document.getElementById('multiPlateSection').classList.remove('hidden');
            renderMultiPlateButtons();
            
            // Show location section with ALL locations
            const locationSection = document.getElementById('multiLocationSection');
            const locationButtons = document.getElementById('multiLocationButtons');
            locationSection.classList.remove('hidden');
            
            // Get rates based on truck type
            let rates;
            if (type === 'denjo') rates = denjoRates;
            else if (type === 'denjo_dump') rates = denjoDumpRates;
            else if (type === 'subcon') rates = subconRates;
            else if (type === 'subcon_dump') rates = subconDumpRates;
            else rates = {};
            
            // Combine ALL locations from all rate types
            const allLocations = new Set([...Object.keys(denjoRates), ...Object.keys(denjoDumpRates), ...Object.keys(subconRates), ...Object.keys(subconDumpRates)]);
            const sortedLocations = Array.from(allLocations).sort();
            
            locationButtons.innerHTML = sortedLocations.map(location => {
                // Check if this location has rates for the selected truck type
                const hasRate = rates[location] !== undefined;
                const buttonClass = hasRate ? 
                    'p-3 border border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-sm font-medium' :
                    'p-3 border border-red-300 bg-red-50 rounded-lg text-sm font-medium text-red-600 cursor-not-allowed opacity-60';
                const buttonText = hasRate ? location : `${location} (No rate for ${type.toUpperCase().replace('_', ' ')})`;
                const onClickAction = hasRate ? `onclick="selectMultiLocation('${location}')"` : '';
                
                return `<button class="${buttonClass}" ${onClickAction}>${buttonText}</button>`;
            }).join('');
            
            // Hide site section initially
            document.getElementById('multiSiteSection').classList.add('hidden');
            
            updateMultiPreview();
        }

        function renderMultiPlateButtons(filteredPlates = null) {
            const plateButtons = document.getElementById('multiPlateButtons');
            let plates;
            if (filteredPlates) {
                plates = filteredPlates;
            } else {
                if (multiSelectedTruckType === 'denjo') plates = denjoPlates;
                else if (multiSelectedTruckType === 'denjo_dump') plates = denjoDumpPlates;
                else if (multiSelectedTruckType === 'subcon') plates = subconPlates;
                else if (multiSelectedTruckType === 'subcon_dump') plates = subconDumpPlates;
                else plates = [];
            }
            
            if (plates.length === 0) {
                plateButtons.innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">No plates found matching your search</div>';
                return;
            }
            
            plateButtons.innerHTML = plates.map(plate => 
                `<button class="${multiSelectedPlates.includes(plate) ? 'p-2 border-2 border-purple-500 bg-purple-50 rounded-lg text-sm font-medium text-purple-700' : 'p-2 border border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-sm font-medium'}" onclick="toggleMultiPlateSelection('${plate}')">${plate}</button>`
            ).join('');
        }

        function renderMixedMultiPlateButtons(denjoMatches, subconMatches) {
            const plateButtons = document.getElementById('multiPlateButtons');
            
            // Combine and sort all matches
            const allMatches = [...denjoMatches, ...subconMatches].sort();
            
            plateButtons.innerHTML = allMatches.map(plate => {
                const isDenjo = denjoMatches.includes(plate);
                const truckTypeColor = isDenjo ? 'blue' : 'green';
                const truckTypeLabel = isDenjo ? 'D' : 'S';
                const isSelected = multiSelectedPlates.includes(plate);
                
                return `<button class="${isSelected ? 'p-2 border-2 border-purple-500 bg-purple-50 rounded-lg text-sm font-medium text-purple-700' : `p-2 border border-gray-300 rounded-lg hover:border-${truckTypeColor}-500 hover:bg-${truckTypeColor}-50 transition-colors text-sm font-medium`}" onclick="selectMultiPlateWithType('${plate}', '${isDenjo ? 'denjo' : 'subcon'}')">
                    <div class="flex items-center justify-between">
                        <span>${plate}</span>
                        <span class="ml-1 px-1 py-0.5 text-xs rounded ${isDenjo ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}">${truckTypeLabel}</span>
                    </div>
                </button>`;
            }).join('');
        }

        function filterMultiPlates() {
            const searchTerm = document.getElementById('multiPlateSearch').value.toUpperCase().trim();
            
            console.log('Multi search term:', searchTerm);
            
            if (searchTerm.length === 0) {
                if (multiSelectedTruckType) {
                    renderMultiPlateButtons();
                } else {
                    // Show initial message when no truck type selected and no search
                    document.getElementById('multiPlateButtons').innerHTML = '<div class="col-span-full text-center text-gray-500 py-4">Select truck type first or start typing to search</div>';
                }
                return;
            }
            
            // Enhanced search - multiple search methods for better accuracy
            const searchFilter = (plate) => {
                const plateUpper = plate.toUpperCase().trim();
                const plateNoSpaces = plateUpper.replace(/\s+/g, '');
                const searchNoSpaces = searchTerm.replace(/\s+/g, '');
                
                return (
                    plateUpper.includes(searchTerm) ||                    // Contains search term exactly
                    plateUpper.startsWith(searchTerm) ||                 // Starts with search term
                    plateNoSpaces.includes(searchNoSpaces) ||            // Remove spaces and search
                    plateUpper.split(' ').some(part => part.includes(searchTerm)) || // Any part contains search term
                    plateUpper.split(' ').some(part => part.startsWith(searchTerm)) || // Any part starts with search term
                    plateUpper.endsWith(searchTerm) ||                   // Ends with search term
                    plateNoSpaces.endsWith(searchNoSpaces)               // Ends with search term (no spaces)
                );
            };
            
            const denjoMatches = denjoPlates.filter(searchFilter);
            const denjoDumpMatches = denjoDumpPlates.filter(searchFilter);
            const subconMatches = subconPlates.filter(searchFilter);
            const subconDumpMatches = subconDumpPlates.filter(searchFilter);
            
            console.log('Multi Denjo matches:', denjoMatches);
            console.log('Multi Subcon matches:', subconMatches);
            
            // Combine all matches and show them
            const allMatches = [...denjoMatches, ...subconMatches].sort();
            
            if (allMatches.length === 0) {
                // No matches found - show helpful message
                document.getElementById('multiPlateButtons').innerHTML = `
                    <div class="col-span-full text-center text-gray-500 py-4">
                        <div>No plates found matching "${searchTerm}"</div>
                        <div class="text-xs mt-2">üí° Try searching with just letters (e.g., "WMZ") or numbers (e.g., "181")</div>
                    </div>`;
                return;
            }
            
            // Auto-detect and set truck type if only one type has matches
            if (denjoMatches.length > 0 && subconMatches.length === 0) {
                // Only Denjo matches found
                if (multiSelectedTruckType !== 'denjo') {
                    selectMultiTruckType('denjo');
                }
                renderMultiPlateButtons(denjoMatches);
            } else if (subconMatches.length > 0 && denjoMatches.length === 0) {
                // Only Subcon matches found
                if (multiSelectedTruckType !== 'subcon') {
                    selectMultiTruckType('subcon');
                }
                renderMultiPlateButtons(subconMatches);
            } else {
                // Both types have matches - show all with type indicators
                renderMixedMultiPlateButtons(denjoMatches, subconMatches);
            }
        }

        function toggleMultiPlateSelection(plate) {
            if (multiSelectedPlates.includes(plate)) {
                multiSelectedPlates = multiSelectedPlates.filter(p => p !== plate);
            } else {
                multiSelectedPlates.push(plate);
            }
            
            updateMultiSelectedPlatesDisplay();
            renderMultiPlateButtons();
            updateMultiPreview();
        }

        function selectMultiPlateWithType(plate, truckType) {
            // Auto-select truck type if not already selected or if different
            if (multiSelectedTruckType !== truckType) {
                selectMultiTruckType(truckType);
            }
            
            // Add plate to selection
            if (!multiSelectedPlates.includes(plate)) {
                multiSelectedPlates.push(plate);
            }
            
            // Clear search input after selecting a plate
            document.getElementById('multiPlateSearch').value = '';
            
            // Reset plate buttons to show all available plates for current truck type
            renderMultiPlateButtons();
            
            // Update displays
            updateMultiSelectedPlatesDisplay();
            updateMultiPreview();
        }

        function updateMultiSelectedPlatesDisplay() {
            const display = document.getElementById('multiSelectedPlatesDisplay');
            const list = document.getElementById('multiSelectedPlatesList');
            
            if (multiSelectedPlates.length === 0) {
                display.classList.add('hidden');
                return;
            }
            
            display.classList.remove('hidden');
            list.innerHTML = multiSelectedPlates.map(plate => 
                `<span class="inline-flex items-center gap-1 px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium">
                    ${plate}
                    <button onclick="removeMultiPlateFromSelection('${plate}')" class="text-purple-500 hover:text-purple-700 ml-1">√ó</button>
                </span>`
            ).join('');
        }

        function removeMultiPlateFromSelection(plate) {
            multiSelectedPlates = multiSelectedPlates.filter(p => p !== plate);
            updateMultiSelectedPlatesDisplay();
            renderMultiPlateButtons();
            updateMultiPreview();
        }

        function clearAllMultiSelectedPlates() {
            multiSelectedPlates = [];
            updateMultiSelectedPlatesDisplay();
            renderMultiPlateButtons();
            updateMultiPreview();
        }

        function selectMultiLocation(location) {
            multiSelectedLocation = location;
            
            // Update location button styles
            const rates = multiSelectedTruckType === 'denjo' ? denjoRates : subconRates;
            const locationButtons = document.getElementById('multiLocationButtons');
            locationButtons.innerHTML = Object.keys(rates).map(loc => {
                // Check if this location has selected sites
                const hasSelectedSites = multiSitesByLocation[loc] && multiSitesByLocation[loc].length > 0;
                const siteCount = hasSelectedSites ? multiSitesByLocation[loc].length : 0;
                const baseClass = 'p-3 border rounded-lg text-sm font-medium transition-colors';
                
                if (loc === location) {
                    return `<button class="${baseClass} border-2 border-purple-500 bg-purple-50 text-purple-700" onclick="selectMultiLocation('${loc}')">${loc}${hasSelectedSites ? ` ‚úì(${siteCount})` : ''}</button>`;
                } else if (hasSelectedSites) {
                    return `<button class="${baseClass} border-2 border-green-400 bg-green-50 text-green-700 hover:border-purple-500 hover:bg-purple-50" onclick="selectMultiLocation('${loc}')">${loc} ‚úì(${siteCount})</button>`;
                } else {
                    return `<button class="${baseClass} border-gray-300 hover:border-purple-500 hover:bg-purple-50" onclick="selectMultiLocation('${loc}')">${loc}</button>`;
                }
            }).join('');
            
            // Show and populate site section
            const siteSection = document.getElementById('multiSiteSection');
            const siteButtons = document.getElementById('multiSiteButtons');
            siteSection.classList.remove('hidden');
            
            if (locationSites[location]) {
                // Get previously selected sites for this location with counts
                const selectedSitesForLocation = multiSitesByLocation[location] || [];
                
                siteButtons.innerHTML = locationSites[location].map(site => {
                    const siteCount = selectedSitesForLocation.filter(siteObj => siteObj.site === site).length;
                    const isSelected = siteCount > 0;
                    const countText = siteCount > 1 ? ` (${siteCount})` : '';
                    return `<button class="${isSelected ? 'p-2 border-2 border-purple-500 bg-purple-50 rounded-lg text-sm font-medium text-purple-700' : 'p-2 border border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-sm font-medium'}" onclick="toggleMultiSiteSelection('${site}')">${site}${countText}</button>`;
                }).join('');
            }
            
            updateMultiSelectedSitesDisplay();
            updateMultiPreview();
        }

        function toggleMultiSiteSelection(site) {
            // Initialize location array if it doesn't exist
            if (!multiSitesByLocation[multiSelectedLocation]) {
                multiSitesByLocation[multiSelectedLocation] = [];
            }
            
            // Always add the site (allow multiple selections of same site)
            const today = new Date().toISOString().split('T')[0];
            multiSitesByLocation[multiSelectedLocation].push({
                site: site,
                date: today,
                id: Date.now() + Math.random() // Unique ID for each selection
            });
            
            // Update global multiSelectedSites array with all sites from all locations
            multiSelectedSites = [];
            Object.values(multiSitesByLocation).forEach(sites => {
                sites.forEach(siteObj => {
                    multiSelectedSites.push(siteObj.site);
                });
            });
            
            // Update site button styles for current location - show count if multiple selections
            const siteButtons = document.getElementById('multiSiteButtons');
            siteButtons.innerHTML = locationSites[multiSelectedLocation].map(s => {
                const siteCount = multiSitesByLocation[multiSelectedLocation].filter(siteObj => siteObj.site === s).length;
                const isSelected = siteCount > 0;
                const countText = siteCount > 1 ? ` (${siteCount})` : '';
                return `<button class="${isSelected ? 'p-2 border-2 border-purple-500 bg-purple-50 rounded-lg text-sm font-medium text-purple-700' : 'p-2 border border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-sm font-medium'}" onclick="toggleMultiSiteSelection('${s}')">${s}${countText}</button>`;
            }).join('');
            
            // Update location buttons to show checkmarks
            selectMultiLocation(multiSelectedLocation);
            
            updateMultiSelectedSitesDisplay();
            updateMultiPreview();
        }

        function updateMultiSelectedSitesDisplay() {
            const display = document.getElementById('multiSelectedSitesDisplay');
            const list = document.getElementById('multiSelectedSitesList');
            
            if (multiSelectedSites.length === 0) {
                display.classList.add('hidden');
                return;
            }
            
            display.classList.remove('hidden');
            
            // Group sites by location for display
            let displayHTML = '';
            Object.entries(multiSitesByLocation).forEach(([location, sites]) => {
                if (sites.length > 0) {
                    displayHTML += `<div class="w-full mb-4 p-3 bg-white rounded-lg border border-gray-200">
                        <div class="text-sm font-bold text-gray-700 mb-3">${location} (${sites.length} entries):</div>
                        <div class="space-y-2">
                            ${sites.map((siteObj, index) => 
                                `<div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                                    <div class="flex-1">
                                        <span class="font-medium text-gray-800">${siteObj.site}</span>
                                        <span class="text-xs text-gray-500 ml-2">#${index + 1}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="date" value="${siteObj.date}" 
                                               onchange="updateSiteDate('${location}', ${index}, this.value)"
                                               class="px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                        <button onclick="removeSpecificSiteEntry('${location}', ${index})" 
                                                class="text-red-500 hover:text-red-700 font-bold text-lg">√ó</button>
                                    </div>
                                </div>`
                            ).join('')}
                        </div>
                    </div>`;
                }
            });
            
            list.innerHTML = displayHTML;
        }

        function updateSiteDate(location, siteIndex, newDate) {
            if (multiSitesByLocation[location] && multiSitesByLocation[location][siteIndex]) {
                multiSitesByLocation[location][siteIndex].date = newDate;
                updateMultiPreview();
            }
        }

        function removeSpecificSiteEntry(location, index) {
            // Remove specific entry by index
            if (multiSitesByLocation[location] && multiSitesByLocation[location][index]) {
                multiSitesByLocation[location].splice(index, 1);
            }
            
            // Update global multiSelectedSites array
            multiSelectedSites = [];
            Object.values(multiSitesByLocation).forEach(sites => {
                sites.forEach(siteObj => {
                    multiSelectedSites.push(siteObj.site);
                });
            });
            
            // If we're currently viewing this location, update the site buttons
            if (multiSelectedLocation === location) {
                const siteButtons = document.getElementById('multiSiteButtons');
                siteButtons.innerHTML = locationSites[multiSelectedLocation].map(s => {
                    const siteCount = multiSitesByLocation[multiSelectedLocation].filter(siteObj => siteObj.site === s).length;
                    const isSelected = siteCount > 0;
                    const countText = siteCount > 1 ? ` (${siteCount})` : '';
                    return `<button class="${isSelected ? 'p-2 border-2 border-purple-500 bg-purple-50 rounded-lg text-sm font-medium text-purple-700' : 'p-2 border border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-sm font-medium'}" onclick="toggleMultiSiteSelection('${s}')">${s}${countText}</button>`;
                }).join('');
            }
            
            // Update location buttons to show/hide checkmarks
            selectMultiLocation(multiSelectedLocation);
            
            updateMultiSelectedSitesDisplay();
            updateMultiPreview();
        }

        function removeMultiSiteFromSelection(site, location) {
            // Remove ALL entries of this site from specific location
            if (multiSitesByLocation[location]) {
                multiSitesByLocation[location] = multiSitesByLocation[location].filter(siteObj => siteObj.site !== site);
            }
            
            // Update global multiSelectedSites array
            multiSelectedSites = [];
            Object.values(multiSitesByLocation).forEach(sites => {
                sites.forEach(siteObj => {
                    multiSelectedSites.push(siteObj.site);
                });
            });
            
            // If we're currently viewing this location, update the site buttons
            if (multiSelectedLocation === location) {
                const siteButtons = document.getElementById('multiSiteButtons');
                siteButtons.innerHTML = locationSites[multiSelectedLocation].map(s => {
                    const siteCount = multiSitesByLocation[multiSelectedLocation].filter(siteObj => siteObj.site === s).length;
                    const isSelected = siteCount > 0;
                    const countText = siteCount > 1 ? ` (${siteCount})` : '';
                    return `<button class="${isSelected ? 'p-2 border-2 border-purple-500 bg-purple-50 rounded-lg text-sm font-medium text-purple-700' : 'p-2 border border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-sm font-medium'}" onclick="toggleMultiSiteSelection('${s}')">${s}${countText}</button>`;
                }).join('');
            }
            
            // Update location buttons to show/hide checkmarks
            selectMultiLocation(multiSelectedLocation);
            
            updateMultiSelectedSitesDisplay();
            updateMultiPreview();
        }

        function clearAllMultiSelectedSites() {
            multiSelectedSites = [];
            multiSitesByLocation = {};
            
            // Update site button styles for current location
            if (multiSelectedLocation && locationSites[multiSelectedLocation]) {
                const siteButtons = document.getElementById('multiSiteButtons');
                siteButtons.innerHTML = locationSites[multiSelectedLocation].map(site => 
                    `<button class="p-2 border border-gray-300 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-colors text-sm font-medium" onclick="toggleMultiSiteSelection('${site}')">${site}</button>`
                ).join('');
            }
            
            // Update location buttons to remove checkmarks
            if (multiSelectedLocation) {
                selectMultiLocation(multiSelectedLocation);
            }
            
            updateMultiSelectedSitesDisplay();
            updateMultiPreview();
        }

        function updateMultiPreview() {
            if (multiSelectedPlates.length === 0 || multiSelectedSites.length === 0) {
                multiRecordCountDiv.textContent = '0 records';
                multiTotalAmountDiv.textContent = '‚Ç±0.00';
                addMultiDispatchBtn.disabled = true;
                return;
            }

            // Calculate total records and amount across all locations with auto-detected truck types
            let totalRecords = 0;
            let totalAmount = 0;
            let hasInvalidRates = false;
            let invalidCombinations = [];
            
            multiSelectedPlates.forEach(plate => {
                // Auto-detect truck type for each plate
                let truckType, rates;
                if (denjoPlates.includes(plate)) {
                    truckType = 'denjo';
                    rates = denjoRates;
                } else if (denjoDumpPlates.includes(plate)) {
                    truckType = 'denjo_dump';
                    rates = denjoDumpRates;
                } else if (subconPlates.includes(plate)) {
                    truckType = 'subcon';
                    rates = subconRates;
                } else if (subconDumpPlates.includes(plate)) {
                    truckType = 'subcon_dump';
                    rates = subconDumpRates;
                } else {
                    truckType = 'unknown';
                    rates = {};
                }
                
                Object.entries(multiSitesByLocation).forEach(([location, sites]) => {
                    const locationRate = rates[location];
                    
                    if (!locationRate || locationRate <= 0) {
                        hasInvalidRates = true;
                        invalidCombinations.push(`${plate} (${truckType.toUpperCase()}) at ${location}`);
                        return; // Skip this combination
                    }
                    
                    const plateRecordsForLocation = sites.length;
                    totalRecords += plateRecordsForLocation;
                    totalAmount += plateRecordsForLocation * locationRate;
                });
            });
            
            multiRecordCountDiv.textContent = `${totalRecords} records`;
            
            if (hasInvalidRates) {
                multiTotalAmountDiv.innerHTML = `
                    <div>‚Ç±${totalAmount.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                    <div class="text-xs text-red-600 mt-1">‚ö†Ô∏è Some combinations have no rates</div>
                `;
                addMultiDispatchBtn.disabled = true;
                addMultiDispatchBtn.textContent = 'Cannot create - Invalid rate combinations';
            } else {
                multiTotalAmountDiv.textContent = `‚Ç±${totalAmount.toLocaleString('en-PH', {minimumFractionDigits: 2})}`;
                
                // Enable button if all fields are filled and no invalid rates
                const allFieldsFilled = multiSelectedPlates.length > 0 && multiSelectedSites.length > 0;
                addMultiDispatchBtn.disabled = !allFieldsFilled;
                
                if (allFieldsFilled) {
                    addMultiDispatchBtn.textContent = 'Create All Dispatch Records';
                }
            }
        }

        function addMultiDispatchRecord() {
            try {
                let totalRecordsAdded = 0;
                
                // Create a record for each combination of plate and site (across all locations)
                multiSelectedPlates.forEach(plate => {
                    // Auto-detect truck type based on plate registration
                    let truckType, rates;
                    if (denjoPlates.includes(plate)) {
                        truckType = 'denjo';
                        rates = denjoRates;
                    } else if (denjoDumpPlates.includes(plate)) {
                        truckType = 'denjo_dump';
                        rates = denjoDumpRates;
                    } else if (subconPlates.includes(plate)) {
                        truckType = 'subcon';
                        rates = subconRates;
                    } else if (subconDumpPlates.includes(plate)) {
                        truckType = 'subcon_dump';
                        rates = subconDumpRates;
                    } else {
                        throw new Error(`Plate "${plate}" not found in any truck type list`);
                    }
                    
                    Object.entries(multiSitesByLocation).forEach(([location, sites]) => {
                        const rate = rates[location];
                        
                        // Enhanced rate validation
                        if (!rate || rate <= 0) {
                            const availableLocations = Object.keys(rates).join(', ');
                            throw new Error(`No rate available for ${truckType.toUpperCase()} truck "${plate}" at location "${location}". Available locations for ${truckType.toUpperCase()}: ${availableLocations}`);
                        }
                        
                        sites.forEach(siteObj => {
                            const record = {
                                id: Date.now() + Math.random() + totalRecordsAdded,
                                truckType: truckType, // Auto-detected based on plate
                                plateNumber: plate,
                                location: location,
                                site: siteObj.site,
                                date: siteObj.date,
                                rate: rate
                            };
                            dispatchRecords.push(record);
                            totalRecordsAdded++;
                        });
                    });
                });

                saveData();
                updateSiteTotals();
                renderDispatchRecords();
                renderSiteTotals();
                
                // Reset multi form
                resetMultiForm();
                
                // Show success message
                showMultiSuccessMessage(totalRecordsAdded);
                
            } catch (error) {
                console.error('‚ùå Error adding multi dispatch records:', error);
                showErrorMessage('Failed to add multi dispatch records: ' + error.message);
            }
        }

        function resetMultiForm() {
            multiSelectedTruckType = '';
            multiSelectedPlates = [];
            multiSelectedLocation = '';
            multiSelectedSites = [];
            multiSitesByLocation = {};
            
            // Reset truck type buttons
            document.getElementById('multiDenjoBtn').className = 'p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors text-center font-semibold';
            document.getElementById('multiDenjoDumpBtn').className = 'p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition-colors text-center font-semibold';
            document.getElementById('multiSubconBtn').className = 'p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors text-center font-semibold';
            document.getElementById('multiSubconDumpBtn').className = 'p-4 border-2 border-gray-300 rounded-lg hover:border-green-500 transition-colors text-center font-semibold';
            
            // Clear search input
            document.getElementById('multiPlateSearch').value = '';
            
            // Hide sections
            document.getElementById('multiPlateSection').classList.add('hidden');
            document.getElementById('multiLocationSection').classList.add('hidden');
            document.getElementById('multiSiteSection').classList.add('hidden');
            
            // Hide selected displays
            updateMultiSelectedPlatesDisplay();
            updateMultiSelectedSitesDisplay();
            
            // Reset preview and button
            multiRecordCountDiv.textContent = '0 records';
            multiTotalAmountDiv.textContent = '‚Ç±0.00';
            addMultiDispatchBtn.disabled = true;
        }

        function showMultiSuccessMessage(totalRecords) {
            const message = document.createElement('div');
            message.className = 'fixed top-4 right-4 bg-purple-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            message.textContent = `‚úì ${totalRecords} dispatch records created successfully!`;
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 3000);
        }

        function generateReport() {
            if (dispatchRecords.length === 0) {
                alert('No dispatch records found. Please add some records first.');
                return;
            }

            // Calculate totals
            let grandTotal = 0;
            let denjoTotal = 0;
            let subconTotal = 0;
            let totalTrips = dispatchRecords.length;
            let denjoTrips = 0;
            let subconTrips = 0;

            dispatchRecords.forEach(record => {
                grandTotal += record.rate;
                if (record.truckType === 'denjo') {
                    denjoTotal += record.rate;
                    denjoTrips++;
                } else {
                    subconTotal += record.rate;
                    subconTrips++;
                }
            });

            // Get date range
            const dates = dispatchRecords.map(r => new Date(r.date)).sort((a, b) => a - b);
            const startDate = dates[0].toLocaleDateString('en-PH');
            const endDate = dates[dates.length - 1].toLocaleDateString('en-PH');

            // Create report content
            const reportContent = `
                <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px;">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #333; padding-bottom: 20px;">
                        <h1 style="color: #333; margin: 0; font-size: 28px;">üöõ TRUCK DISPATCH REPORT</h1>
                        <p style="color: #666; margin: 10px 0 0 0; font-size: 16px;">Generated on ${new Date().toLocaleDateString('en-PH')} at ${new Date().toLocaleTimeString('en-PH')}</p>
                        <p style="color: #666; margin: 5px 0 0 0; font-size: 14px;">Report Period: ${startDate} - ${endDate}</p>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px;">GRAND TOTAL</h3>
                            <p style="margin: 0; font-size: 24px; font-weight: bold;">‚Ç±${grandTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}</p>
                            <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">${totalTrips} total trips</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px;">DENJO TOTAL</h3>
                            <p style="margin: 0; font-size: 24px; font-weight: bold;">‚Ç±${denjoTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}</p>
                            <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">${denjoTrips} trips</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 10px; text-align: center;">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px;">SUBCON TOTAL</h3>
                            <p style="margin: 0; font-size: 24px; font-weight: bold;">‚Ç±${subconTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}</p>
                            <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">${subconTrips} trips</p>
                        </div>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h2 style="color: #333; border-bottom: 2px solid #ddd; padding-bottom: 10px;">üìä SITE BREAKDOWN</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 20px;">
                            ${Object.entries(siteTotals).map(([siteKey, data]) => `
                                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f9f9f9;">
                                    <h4 style="margin: 0 0 5px 0; color: #333; font-size: 14px;">${data.location}</h4>
                                    <h3 style="margin: 0 0 15px 0; color: #333; font-size: 16px;">${data.site}</h3>
                                    ${data.denjoCount > 0 ? `
                                        <div style="background: #dbeafe; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                                            <div style="display: flex; justify-between; align-items: center;">
                                                <span style="font-weight: bold; color: #1e40af;">DENJO:</span>
                                                <span style="font-weight: bold; color: #1e40af;">‚Ç±${data.denjoTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                                            </div>
                                            <div style="font-size: 12px; color: #1e40af;">${data.denjoCount} trips</div>
                                        </div>
                                    ` : ''}
                                    ${data.subconCount > 0 ? `
                                        <div style="background: #dcfce7; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                                            <div style="display: flex; justify-between; align-items: center;">
                                                <span style="font-weight: bold; color: #166534;">SUBCON:</span>
                                                <span style="font-weight: bold; color: #166534;">‚Ç±${data.subconTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                                            </div>
                                            <div style="font-size: 12px; color: #166534;">${data.subconCount} trips</div>
                                        </div>
                                    ` : ''}
                                    <div style="border-top: 1px solid #ccc; padding-top: 10px; margin-top: 10px;">
                                        <div style="display: flex; justify-between; align-items: center;">
                                            <span style="font-weight: bold; color: #7c3aed;">SITE TOTAL:</span>
                                            <span style="font-weight: bold; color: #7c3aed; font-size: 18px;">‚Ç±${data.total.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                                        </div>
                                        <div style="font-size: 12px; color: #666;">${data.count} total trips</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <h2 style="color: #333; border-bottom: 2px solid #ddd; padding-bottom: 10px;">üìã DETAILED RECORDS</h2>
                        <div style="overflow-x: auto; margin-top: 20px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                <thead>
                                    <tr style="background: #f3f4f6;">
                                        <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Date</th>
                                        <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Type</th>
                                        <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Plate</th>
                                        <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Location</th>
                                        <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left;">Site</th>
                                        <th style="border: 1px solid #d1d5db; padding: 8px; text-align: right;">Rate</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${dispatchRecords.sort((a, b) => new Date(b.date) - new Date(a.date)).map(record => `
                                        <tr>
                                            <td style="border: 1px solid #d1d5db; padding: 8px;">${new Date(record.date).toLocaleDateString('en-PH')}</td>
                                            <td style="border: 1px solid #d1d5db; padding: 8px;">
                                                <span style="padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: bold; color: white; background: ${record.truckType === 'denjo' ? '#3b82f6' : '#10b981'};">
                                                    ${record.truckType.toUpperCase()}
                                                </span>
                                            </td>
                                            <td style="border: 1px solid #d1d5db; padding: 8px; font-weight: bold;">${record.plateNumber}</td>
                                            <td style="border: 1px solid #d1d5db; padding: 8px;">${record.location}</td>
                                            <td style="border: 1px solid #d1d5db; padding: 8px;">${record.site}</td>
                                            <td style="border: 1px solid #d1d5db; padding: 8px; text-align: right; font-weight: bold; color: #059669;">‚Ç±${record.rate.toLocaleString('en-PH', {minimumFractionDigits: 2})}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; margin: 30px 0;">
                        <h2 style="margin: 0 0 20px 0; font-size: 24px; font-weight: bold;">üìä SUMMARY TOTALS</h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; max-width: 600px; margin: 0 auto;">
                            <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px;">
                                <div style="font-size: 16px; margin-bottom: 10px; opacity: 0.9;">TOTAL TRIPS</div>
                                <div style="font-size: 36px; font-weight: bold;">${totalTrips}</div>
                                <div style="font-size: 14px; opacity: 0.8; margin-top: 5px;">All dispatch records</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px;">
                                <div style="font-size: 16px; margin-bottom: 10px; opacity: 0.9;">TOTAL SALES</div>
                                <div style="font-size: 36px; font-weight: bold;">‚Ç±${grandTotal.toLocaleString('en-PH', {minimumFractionDigits: 2})}</div>
                                <div style="font-size: 14px; opacity: 0.8; margin-top: 5px;">All revenue generated</div>
                            </div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 2px solid #ddd; color: #666; font-size: 12px;">
                        <p>This report was generated automatically by the Truck Dispatch System</p>
                        <p>Total Records: ${dispatchRecords.length} | Report Generated: ${new Date().toLocaleString('en-PH')}</p>
                    </div>
                </div>
            `;

            // Open report in new window
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Truck Dispatch Report - ${new Date().toLocaleDateString('en-PH')}</title>
                    <style>
                        body { margin: 0; padding: 20px; background: #f5f5f5; }
                        @media print {
                            body { background: white; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="no-print" style="text-align: center; margin-bottom: 20px;">
                        <button onclick="window.print()" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px;">üñ®Ô∏è Print Report</button>
                        <button onclick="window.close()" style="background: #6b7280; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">‚úï Close</button>
                    </div>
                    ${reportContent}
                </body>
                </html>
            `);
            reportWindow.document.close();

            // Show success message
            const message = document.createElement('div');
            message.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            message.textContent = 'üìä Report generated successfully! Check the new window.';
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 3000);
        }

        // Data Management Functions
        function exportData() {
            try {
                const dataToExport = {
                    dispatchRecords: dispatchRecords,
                    exportDate: new Date().toISOString(),
                    totalRecords: dispatchRecords.length,
                    version: '1.0'
                };
                
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `truck-dispatch-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showSuccessMessage(`Exported ${dispatchRecords.length} records successfully!`);
            } catch (error) {
                console.error('Export error:', error);
                showErrorMessage('Failed to export data: ' + error.message);
            }
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate imported data
                    if (!importedData.dispatchRecords || !Array.isArray(importedData.dispatchRecords)) {
                        throw new Error('Invalid data format');
                    }
                    
                    // Backup current data before import
                    const backupData = JSON.stringify(dispatchRecords);
                    localStorage.setItem('dispatchRecords_pre_import_backup', backupData);
                    
                    // Import data
                    dispatchRecords = importedData.dispatchRecords;
                    saveData();
                    updateSiteTotals();
                    renderDispatchRecords();
                    renderSiteTotals();
                    
                    showSuccessMessage(`Imported ${dispatchRecords.length} records successfully!`);
                    
                } catch (error) {
                    console.error('Import error:', error);
                    showErrorMessage('Failed to import data: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        function showDataStatus() {
            const totalRecords = dispatchRecords.length;
            const denjoRecords = dispatchRecords.filter(r => r.truckType === 'denjo').length;
            const subconRecords = dispatchRecords.filter(r => r.truckType === 'subcon').length;
            const totalSites = Object.keys(siteTotals).length;
            
            // Check localStorage usage
            let storageUsed = 0;
            try {
                const data = localStorage.getItem('dispatchRecords');
                storageUsed = data ? data.length : 0;
            } catch (e) {
                storageUsed = 'Unknown';
            }
            
            const lastSaved = localStorage.getItem('dispatchRecords') ? 'Data found in storage' : 'No data in storage';
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">üìä Data Status</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">√ó</button>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="text-sm font-semibold text-blue-700">Total Records</div>
                            <div class="text-2xl font-bold text-blue-800">${totalRecords}</div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-blue-50 p-3 rounded-lg text-center">
                                <div class="text-xs font-semibold text-blue-700">DENJO</div>
                                <div class="text-lg font-bold text-blue-800">${denjoRecords}</div>
                            </div>
                            <div class="bg-green-50 p-3 rounded-lg text-center">
                                <div class="text-xs font-semibold text-green-700">SUBCON</div>
                                <div class="text-lg font-bold text-green-800">${subconRecords}</div>
                            </div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <div class="text-sm font-semibold text-purple-700">Active Sites</div>
                            <div class="text-xl font-bold text-purple-800">${totalSites}</div>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <div class="text-sm font-semibold text-yellow-700">Custom Plates Added</div>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <div class="text-center">
                                    <div class="text-lg font-bold text-blue-600">${customDenjoPlates.length}</div>
                                    <div class="text-xs text-blue-600">Denjo</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-green-600">${customSubconPlates.length}</div>
                                    <div class="text-xs text-green-600">Subcon</div>
                                </div>
                            </div>
                            <div class="text-xs text-yellow-600 mt-2">Total plates: ${denjoPlates.length + subconPlates.length}</div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="text-sm font-semibold text-gray-700">Storage Status</div>
                            <div class="text-sm text-gray-600">${lastSaved}</div>
                            <div class="text-xs text-gray-500">Size: ${storageUsed} characters</div>
                        </div>
                        <div class="text-xs text-gray-500 text-center">
                            üí° Tip: Export your data regularly as backup!
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Initialize
        updateRate();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97efdfeed72e03ab',t:'MTc1Nzg1MjgwNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
